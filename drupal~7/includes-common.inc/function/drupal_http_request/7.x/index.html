
<!DOCTYPE HTML>

<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Drupal_http_request - Drupal 7 - W3cubDocs</title>
  
  <meta name="description" content=" Performs an HTTP request. ">
  <meta name="keywords" content="function, drupal, http, request, -, drupal~7">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="http://docs.w3cub.com/drupal~7/includes-common.inc/function/drupal_http_request/7.x/">
  <link href="/favicon.png" rel="icon">
  <link type="text/css" rel="stylesheet" href="/assets/application-50364fff564ce3b6327021805f3f00e2957b441cf27f576a7dd4ff63bbc47047.css">
  <script type="text/javascript" src="/assets/application-db64bfd54ceb42be11af7995804cf4902548419ceb79d509b0b7d62c22d98e6f.js"></script>
  <script src="/json/drupal~7.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
	<div class="_app">
	<header class="_header">
  
  <form class="_search">
    <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
    <a class="_search-clear"></a>
    <div class="_search-tag"></div>
  </form>
  
  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/drupal~7/" class="_nav-link" title="" style="margin-left:0;">Drupal 7</a></span>
  
  <nav class="_nav">
    <a href="/app/" class="_nav-link ">App</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		<div class="_list">
			
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<div class="_page _drupal">
				
<h1 id="page-subtitle">function drupal_http_request</h1>     <pre class="signature">drupal_http_request($url, array $options = array())</pre> <p>Performs an HTTP request.</p> <p>This is a flexible and powerful HTTP client implementation. Correctly handles GET, POST, PUT or any other HTTP requests. Handles redirects.</p> <h3>Parameters</h3> <p> <strong>$url</strong>: A string containing a fully qualified URI.</p> <p><strong>array $options</strong>: (optional) An array that can have one or more of the following elements:</p> <ul> <li>
<strong>headers</strong>: An array containing request headers to send as name/value pairs.</li> <li>
<strong>method</strong>: A string containing the request method. Defaults to 'GET'.</li> <li>
<strong>data</strong>: A string containing the request body, formatted as 'param=value&amp;param=value&amp;...'; to generate this, use <a href="http://php.net/http_build_query" title="string http_build_query(mixed $query_data [, string $numeric_prefix = '' [, string $arg_separator = '' [, int $enc_type = '']]])
  Generate URL-encoded query string" class="php-manual" target="_blank">http_build_query</a>(). Defaults to NULL.</li> <li>
<strong>max_redirects</strong>: An integer representing how many times a redirect may be followed. Defaults to 3.</li> <li>
<strong>timeout</strong>: A float representing the maximum number of seconds the function call may take. The default is 30 seconds. If a timeout occurs, the error code is set to the <a href="../../../constant/http_request_timeout/7.x/" title="Error code indicating that the request exceeded the specified timeout." class="local">HTTP_REQUEST_TIMEOUT</a> constant.</li> <li>
<strong>context</strong>: A context resource created with <a href="http://php.net/stream_context_create" title="resource stream_context_create([array $options = '' [, array $params = '']])
  Creates a stream context" class="php-manual" target="_blank">stream_context_create</a>().</li> </ul> <h3>Return value</h3> <p> object An object that can have one or more of the following components:</p> <ul> <li>
<strong>request</strong>: A string containing the request body that was sent.</li> <li>
<strong>code</strong>: An integer containing the response status code, or the error code if an error occurred.</li> <li>
<strong>protocol</strong>: The response protocol (e.g. HTTP/1.1 or HTTP/1.0).</li> <li>
<strong>status_message</strong>: The status message from the response, if a response was received.</li> <li>
<strong>redirect_code</strong>: If redirected, an integer containing the initial response status code.</li> <li>
<strong>redirect_url</strong>: If redirected, a string containing the URL of the redirect target.</li> <li>
<strong>error</strong>: If an error occurred, the error message. Otherwise not set.</li> <li>
<strong>headers</strong>: An array containing the response headers as name/value pairs. HTTP header names are case-insensitive (RFC 2616, section 4.2), so for easy access the array keys are returned in lower case.</li> <li>
<strong>data</strong>: A string containing the response body that was received.</li> </ul> <h3>See also</h3> <p> <a href="http://php.net/http_build_query" title="string http_build_query(mixed $query_data [, string $numeric_prefix = '' [, string $arg_separator = '' [, int $enc_type = '']]])
  Generate URL-encoded query string" class="php-manual" target="_blank">http_build_query</a>()</p> <h3>Related topics</h3> <div class="view view-api-references view-id-api_references view-display-id-block_related_topics view-dom-id-7d22663fac1fcbd8c173f7d1d8272bc2"> <div class="view-content"> <dl api-related-topics> <dt><a href="../../../group/http_handling/7.x/">HTTP handling</a></dt> <dd>Functions to properly handle HTTP responses.</dd> </dl> </div> </div>  <h3>File</h3> 
<dl> <dt>includes/<a href="../../../7.x/">common.inc</a>, line 792</dt> <dd>Common functions that many Drupal modules will need to reference.</dd> </dl> <h3>Code</h3> <pre class="php" data-language="php">function drupal_http_request($url, array $options = array()) {
  // Allow an alternate HTTP client library to replace Drupal's default
  // implementation.
  $override_function = variable_get('drupal_http_request_function', FALSE);
  if (!empty($override_function) &amp;&amp; function_exists($override_function)) {
    return $override_function($url, $options);
  }

  $result = new stdClass();

  // Parse the URL and make sure we can handle the schema.
  $uri = @parse_url($url);

  if ($uri == FALSE) {
    $result-&gt;error = 'unable to parse URL';
    $result-&gt;code = -1001;
    return $result;
  }

  if (!isset($uri['scheme'])) {
    $result-&gt;error = 'missing schema';
    $result-&gt;code = -1002;
    return $result;
  }

  timer_start(__FUNCTION__);

  // Merge the default options.
  $options += array(
    'headers' =&gt; array(),
    'method' =&gt; 'GET',
    'data' =&gt; NULL,
    'max_redirects' =&gt; 3,
    'timeout' =&gt; 30.0,
    'context' =&gt; NULL,
  );

  // Merge the default headers.
  $options['headers'] += array(
    'User-Agent' =&gt; 'Drupal (+http://drupal.org/)',
  );

  // stream_socket_client() requires timeout to be a float.
  $options['timeout'] = (float) $options['timeout'];

  // Use a proxy if one is defined and the host is not on the excluded list.
  $proxy_server = variable_get('proxy_server', '');
  if ($proxy_server &amp;&amp; _drupal_http_use_proxy($uri['host'])) {
    // Set the scheme so we open a socket to the proxy server.
    $uri['scheme'] = 'proxy';
    // Set the path to be the full URL.
    $uri['path'] = $url;
    // Since the URL is passed as the path, we won't use the parsed query.
    unset($uri['query']);

    // Add in username and password to Proxy-Authorization header if needed.
    if ($proxy_username = variable_get('proxy_username', '')) {
      $proxy_password = variable_get('proxy_password', '');
      $options['headers']['Proxy-Authorization'] = 'Basic ' . base64_encode($proxy_username . (!empty($proxy_password) ? ":" . $proxy_password : ''));
    }
    // Some proxies reject requests with any User-Agent headers, while others
    // require a specific one.
    $proxy_user_agent = variable_get('proxy_user_agent', '');
    // The default value matches neither condition.
    if ($proxy_user_agent === NULL) {
      unset($options['headers']['User-Agent']);
    }
    elseif ($proxy_user_agent) {
      $options['headers']['User-Agent'] = $proxy_user_agent;
    }
  }

  switch ($uri['scheme']) {
    case 'proxy':
      // Make the socket connection to a proxy server.
      $socket = 'tcp://' . $proxy_server . ':' . variable_get('proxy_port', 8080);
      // The Host header still needs to match the real request.
      $options['headers']['Host'] = $uri['host'];
      $options['headers']['Host'] .= isset($uri['port']) &amp;&amp; $uri['port'] != 80 ? ':' . $uri['port'] : '';
      break;

    case 'http':
    case 'feed':
      $port = isset($uri['port']) ? $uri['port'] : 80;
      $socket = 'tcp://' . $uri['host'] . ':' . $port;
      // RFC 2616: "non-standard ports MUST, default ports MAY be included".
      // We don't add the standard port to prevent from breaking rewrite rules
      // checking the host that do not take into account the port number.
      $options['headers']['Host'] = $uri['host'] . ($port != 80 ? ':' . $port : '');
      break;

    case 'https':
      // Note: Only works when PHP is compiled with OpenSSL support.
      $port = isset($uri['port']) ? $uri['port'] : 443;
      $socket = 'ssl://' . $uri['host'] . ':' . $port;
      $options['headers']['Host'] = $uri['host'] . ($port != 443 ? ':' . $port : '');
      break;

    default:
      $result-&gt;error = 'invalid schema ' . $uri['scheme'];
      $result-&gt;code = -1003;
      return $result;
  }

  if (empty($options['context'])) {
    $fp = @stream_socket_client($socket, $errno, $errstr, $options['timeout']);
  }
  else {
    // Create a stream with context. Allows verification of a SSL certificate.
    $fp = @stream_socket_client($socket, $errno, $errstr, $options['timeout'], STREAM_CLIENT_CONNECT, $options['context']);
  }

  // Make sure the socket opened properly.
  if (!$fp) {
    // When a network error occurs, we use a negative number so it does not
    // clash with the HTTP status codes.
    $result-&gt;code = -$errno;
    $result-&gt;error = trim($errstr) ? trim($errstr) : t('Error opening socket @socket', array('@socket' =&gt; $socket));

    // Mark that this request failed. This will trigger a check of the web
    // server's ability to make outgoing HTTP requests the next time that
    // requirements checking is performed.
    // See system_requirements().
    variable_set('drupal_http_request_fails', TRUE);

    return $result;
  }

  // Construct the path to act on.
  $path = isset($uri['path']) ? $uri['path'] : '/';
  if (isset($uri['query'])) {
    $path .= '?' . $uri['query'];
  }

  // Only add Content-Length if we actually have any content or if it is a POST
  // or PUT request. Some non-standard servers get confused by Content-Length in
  // at least HEAD/GET requests, and Squid always requires Content-Length in
  // POST/PUT requests.
  $content_length = strlen($options['data']);
  if ($content_length &gt; 0 || $options['method'] == 'POST' || $options['method'] == 'PUT') {
    $options['headers']['Content-Length'] = $content_length;
  }

  // If the server URL has a user then attempt to use basic authentication.
  if (isset($uri['user'])) {
    $options['headers']['Authorization'] = 'Basic ' . base64_encode($uri['user'] . (isset($uri['pass']) ? ':' . $uri['pass'] : ':'));
  }

  // If the database prefix is being used by SimpleTest to run the tests in a copied
  // database then set the user-agent header to the database prefix so that any
  // calls to other Drupal pages will run the SimpleTest prefixed database. The
  // user-agent is used to ensure that multiple testing sessions running at the
  // same time won't interfere with each other as they would if the database
  // prefix were stored statically in a file or database variable.
  $test_info = &amp;$GLOBALS['drupal_test_info'];
  if (!empty($test_info['test_run_id'])) {
    $options['headers']['User-Agent'] = drupal_generate_test_ua($test_info['test_run_id']);
  }

  $request = $options['method'] . ' ' . $path . " HTTP/1.0\r\n";
  foreach ($options['headers'] as $name =&gt; $value) {
    $request .= $name . ': ' . trim($value) . "\r\n";
  }
  $request .= "\r\n" . $options['data'];
  $result-&gt;request = $request;
  // Calculate how much time is left of the original timeout value.
  $timeout = $options['timeout'] - timer_read(__FUNCTION__) / 1000;
  if ($timeout &gt; 0) {
    stream_set_timeout($fp, floor($timeout), floor(1000000 * fmod($timeout, 1)));
    fwrite($fp, $request);
  }

  // Fetch response. Due to PHP bugs like http://bugs.php.net/bug.php?id=43782
  // and http://bugs.php.net/bug.php?id=46049 we can't rely on feof(), but
  // instead must invoke stream_get_meta_data() each iteration.
  $info = stream_get_meta_data($fp);
  $alive = !$info['eof'] &amp;&amp; !$info['timed_out'];
  $response = '';

  while ($alive) {
    // Calculate how much time is left of the original timeout value.
    $timeout = $options['timeout'] - timer_read(__FUNCTION__) / 1000;
    if ($timeout &lt;= 0) {
      $info['timed_out'] = TRUE;
      break;
    }
    stream_set_timeout($fp, floor($timeout), floor(1000000 * fmod($timeout, 1)));
    $chunk = fread($fp, 1024);
    $response .= $chunk;
    $info = stream_get_meta_data($fp);
    $alive = !$info['eof'] &amp;&amp; !$info['timed_out'] &amp;&amp; $chunk;
  }
  fclose($fp);

  if ($info['timed_out']) {
    $result-&gt;code = HTTP_REQUEST_TIMEOUT;
    $result-&gt;error = 'request timed out';
    return $result;
  }
  // Parse response headers from the response body.
  // Be tolerant of malformed HTTP responses that separate header and body with
  // \n\n or \r\r instead of \r\n\r\n.
  list($response, $result-&gt;data) = preg_split("/\r\n\r\n|\n\n|\r\r/", $response, 2);
  $response = preg_split("/\r\n|\n|\r/", $response);

  // Parse the response status line.
  $response_status_array = _drupal_parse_response_status(trim(array_shift($response)));
  $result-&gt;protocol = $response_status_array['http_version'];
  $result-&gt;status_message = $response_status_array['reason_phrase'];
  $code = $response_status_array['response_code'];

  $result-&gt;headers = array();

  // Parse the response headers.
  while ($line = trim(array_shift($response))) {
    list($name, $value) = explode(':', $line, 2);
    $name = strtolower($name);
    if (isset($result-&gt;headers[$name]) &amp;&amp; $name == 'set-cookie') {
      // RFC 2109: the Set-Cookie response header comprises the token Set-
      // Cookie:, followed by a comma-separated list of one or more cookies.
      $result-&gt;headers[$name] .= ',' . trim($value);
    }
    else {
      $result-&gt;headers[$name] = trim($value);
    }
  }

  $responses = array(
    100 =&gt; 'Continue',
    101 =&gt; 'Switching Protocols',
    200 =&gt; 'OK',
    201 =&gt; 'Created',
    202 =&gt; 'Accepted',
    203 =&gt; 'Non-Authoritative Information',
    204 =&gt; 'No Content',
    205 =&gt; 'Reset Content',
    206 =&gt; 'Partial Content',
    300 =&gt; 'Multiple Choices',
    301 =&gt; 'Moved Permanently',
    302 =&gt; 'Found',
    303 =&gt; 'See Other',
    304 =&gt; 'Not Modified',
    305 =&gt; 'Use Proxy',
    307 =&gt; 'Temporary Redirect',
    400 =&gt; 'Bad Request',
    401 =&gt; 'Unauthorized',
    402 =&gt; 'Payment Required',
    403 =&gt; 'Forbidden',
    404 =&gt; 'Not Found',
    405 =&gt; 'Method Not Allowed',
    406 =&gt; 'Not Acceptable',
    407 =&gt; 'Proxy Authentication Required',
    408 =&gt; 'Request Time-out',
    409 =&gt; 'Conflict',
    410 =&gt; 'Gone',
    411 =&gt; 'Length Required',
    412 =&gt; 'Precondition Failed',
    413 =&gt; 'Request Entity Too Large',
    414 =&gt; 'Request-URI Too Large',
    415 =&gt; 'Unsupported Media Type',
    416 =&gt; 'Requested range not satisfiable',
    417 =&gt; 'Expectation Failed',
    500 =&gt; 'Internal Server Error',
    501 =&gt; 'Not Implemented',
    502 =&gt; 'Bad Gateway',
    503 =&gt; 'Service Unavailable',
    504 =&gt; 'Gateway Time-out',
    505 =&gt; 'HTTP Version not supported',
  );
  // RFC 2616 states that all unknown HTTP codes must be treated the same as the
  // base code in their class.
  if (!isset($responses[$code])) {
    $code = floor($code / 100) * 100;
  }
  $result-&gt;code = $code;

  switch ($code) {
    case 200: // OK
    case 201: // Created
    case 202: // Accepted
    case 203: // Non-Authoritative Information
    case 204: // No Content
    case 205: // Reset Content
    case 206: // Partial Content
    case 304: // Not modified
      break;
    case 301: // Moved permanently
    case 302: // Moved temporarily
    case 307: // Moved temporarily
      $location = $result-&gt;headers['location'];
      $options['timeout'] -= timer_read(__FUNCTION__) / 1000;
      if ($options['timeout'] &lt;= 0) {
        $result-&gt;code = HTTP_REQUEST_TIMEOUT;
        $result-&gt;error = 'request timed out';
      }
      elseif ($options['max_redirects']) {
        // Redirect to the new location.
        $options['max_redirects']--;
        $result = drupal_http_request($location, $options);
        $result-&gt;redirect_code = $code;
      }
      if (!isset($result-&gt;redirect_url)) {
        $result-&gt;redirect_url = $location;
      }
      break;
    default:
      $result-&gt;error = $result-&gt;status_message;
  }

  return $result;
}
</pre>
<div class="_attribution">
  <p class="_attribution-p">
    © 2001–2016 by the original authors<br>Licensed under the GNU General Public License, version 2 and later.<br>Drupal is a registered trademark of Dries Buytaert.<br>
    <a href="https://api.drupal.org/api/drupal/includes!common.inc/function/drupal_http_request/7.x" class="_attribution-link" target="_blank">https://api.drupal.org/api/drupal/includes!common.inc/function/drupal_http_request/7.x</a>
  </p>
</div>

			</div>
		</div>
	</section>

	</div>
</body>
</html>
