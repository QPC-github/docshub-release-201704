
<!DOCTYPE HTML>

<html lang="en">

<head>
  <meta charset="utf-8">
  <title>SQLite Shared-Cache Mode - SQLite - W3cubDocs</title>
  
  <meta name="description" content="Starting with version 3.3.0 (2006-01-11), SQLite includes a special &#34;shared-cache&#34; mode (disabled by default) intended for use in embedded &hellip;">
  <meta name="keywords" content="sqlite, shared-cache, mode, locking, model, thread, related, issues, shared, cache, and, virtual, tables, enabling, in-memory, databases, -">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="http://docs.w3cub.com/sqlite/sharedcache/">
  <link href="/favicon.png" rel="icon">
  <link type="text/css" rel="stylesheet" href="/assets/application-50364fff564ce3b6327021805f3f00e2957b441cf27f576a7dd4ff63bbc47047.css">
  <script type="text/javascript" src="/assets/application-db64bfd54ceb42be11af7995804cf4902548419ceb79d509b0b7d62c22d98e6f.js"></script>
  <script src="/json/sqlite.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
	<div class="_app">
	<header class="_header">
  
  <form class="_search">
    <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
    <a class="_search-clear"></a>
    <div class="_search-tag"></div>
  </form>
  
  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/sqlite/" class="_nav-link" title="" style="margin-left:0;">SQLite</a></span>
  
  <nav class="_nav">
    <a href="/app/" class="_nav-link ">App</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		<div class="_list">
			
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<div class="_page _sqlite">
				
<h1 class="fancy_title"> SQLite Shared-Cache Mode </h1> <div class="fancy_toc">  <div id="toc_sub">
<div class="fancy-toc1"><a href="#sqlite_shared_cache_mode">1. SQLite Shared-Cache Mode</a></div> <div class="fancy-toc1"><a href="#shared_cache_locking_model">2. Shared-Cache Locking Model</a></div> <div class="fancy-toc2"><a href="#transaction_level_locking">2.1. Transaction Level Locking</a></div> <div class="fancy-toc2"><a href="#table_level_locking">2.2. Table Level Locking</a></div> <div class="fancy-toc3"><a href="#read_uncommitted_isolation_mode">2.2.1. Read-Uncommitted Isolation Mode</a></div> <div class="fancy-toc2"><a href="#schema_sqlite_master_level_locking">2.3. Schema (sqlite_master) Level Locking</a></div> <div class="fancy-toc1"><a href="#thread_related_issues">3. Thread Related Issues</a></div> <div class="fancy-toc1"><a href="#shared_cache_and_virtual_tables">4. Shared Cache And Virtual Tables</a></div> <div class="fancy-toc1"><a href="#enabling_shared_cache_mode">5. Enabling Shared-Cache Mode</a></div> <div class="fancy-toc1"><a href="#shared_cache_and_in_memory_databases">6. Shared Cache And In-Memory Databases</a></div> </div> </div>   <h1 id="sqlite_shared_cache_mode">
<span>1. </span>SQLite Shared-Cache Mode</h1> <p>Starting with <a href="https://sqlite.org/releaselog/3_3_0.html" target="_blank">version 3.3.0</a> (2006-01-11), SQLite includes a special "shared-cache" mode (disabled by default) intended for use in embedded servers. If shared-cache mode is enabled and a thread establishes multiple connections to the same database, the connections share a single data and schema cache. This can significantly reduce the quantity of memory and IO required by the system.</p> <p>In <a href="https://sqlite.org/releaselog/3_5_0.html" target="_blank">version 3.5.0</a> (2007-09-04), shared-cache mode was modified so that the same cache can be shared across an entire process rather than just within a single thread. Prior to this change, there were restrictions on passing database connections between threads. Those restrictions were dropped in 3.5.0 update. This document describes shared-cache mode as of version 3.5.0.</p> <p>Shared-cache mode changes the semantics of the locking model in some cases. The details are described by this document. A basic understanding of the normal SQLite locking model (see <a href="../lockingv3/">File Locking And Concurrency In SQLite Version 3</a> for details) is assumed.</p> <h1 id="shared_cache_locking_model">
<span>2. </span>Shared-Cache Locking Model</h1> <p>Externally, from the point of view of another process or thread, two or more <a href="../c3ref/sqlite3/">database connections</a> using a shared-cache appear as a single connection. The locking protocol used to arbitrate between multiple shared-caches or regular database users is described elsewhere. </p> <table> <tr><td> <img src="https://sqlite.org/images/shared.gif"> </td></tr>
</table> <p>Figure 1</p> <p>Figure 1 depicts an example runtime configuration where three database connections have been established. Connection 1 is a normal SQLite database connection. Connections 2 and 3 share a cache The normal locking protocol is used to serialize database access between connection 1 and the shared cache. The internal protocol used to serialize (or not, see "Read-Uncommitted Isolation Mode" below) access to the shared-cache by connections 2 and 3 is described in the remainder of this section. </p> <p>There are three levels to the shared-cache locking model, transaction level locking, table level locking and schema level locking. They are described in the following three sub-sections.</p> <h2 id="transaction_level_locking">
<span>2.1. </span>Transaction Level Locking</h2> <p>SQLite connections can open two kinds of transactions, read and write transactions. This is not done explicitly, a transaction is implicitly a read-transaction until it first writes to a database table, at which point it becomes a write-transaction. </p> <p>At most one connection to a single shared cache may open a write transaction at any one time. This may co-exist with any number of read transactions. </p> <h2 id="table_level_locking">
<span>2.2. </span>Table Level Locking</h2> <p>When two or more connections use a shared-cache, locks are used to serialize concurrent access attempts on a per-table basis. Tables support two types of locks, "read-locks" and "write-locks". Locks are granted to connections - at any one time, each database connection has either a read-lock, write-lock or no lock on each database table. </p> <p>At any one time, a single table may have any number of active read-locks or a single active write lock. To read data a table, a connection must first obtain a read-lock. To write to a table, a connection must obtain a write-lock on that table. If a required table lock cannot be obtained, the query fails and SQLITE_LOCKED is returned to the caller. </p> <p>Once a connection obtains a table lock, it is not released until the current transaction (read or write) is concluded. </p> <h3 id="read_uncommitted_isolation_mode">
<span>2.2.1. </span>Read-Uncommitted Isolation Mode</h3> <p>The behaviour described above may be modified slightly by using the <a href="../pragma/#pragma_read_uncommitted">read_uncommitted</a> pragma to change the isolation level from serialized (the default), to read-uncommitted.</p> <p> A database connection in read-uncommitted mode does not attempt to obtain read-locks before reading from database tables as described above. This can lead to inconsistent query results if another database connection modifies a table while it is being read, but it also means that a read-transaction opened by a connection in read-uncommitted mode can neither block nor be blocked by any other connection.</p> <p>Read-uncommitted mode has no effect on the locks required to write to database tables (i.e. read-uncommitted connections must still obtain write-locks and hence database writes may still block or be blocked). Also, read-uncommitted mode has no effect on the <i>sqlite_master</i> locks required by the rules enumerated below (see section "Schema (sqlite_master) Level Locking"). </p> <pre data-language="sql">
  /* Set the value of the read-uncommitted flag:
  **
  **   True  -&gt; Set the connection to read-uncommitted mode.
  **   False -&gt; Set the connection to serialized (the default) mode.
  */
  PRAGMA read_uncommitted = &lt;boolean&gt;;

  /* Retrieve the current value of the read-uncommitted flag */
  PRAGMA read_uncommitted;
</pre> <h2 id="schema_sqlite_master_level_locking">
<span>2.3. </span>Schema (sqlite_master) Level Locking</h2> <p>The <i>sqlite_master</i> table supports shared-cache read and write locks in the same way as all other database tables (see description above). The following special rules also apply: </p> <ul> <li>A connection must obtain a read-lock on <i>sqlite_master</i> before accessing any database tables or obtaining any other read or write locks.</li> <li>Before executing a statement that modifies the database schema (i.e. a CREATE or DROP TABLE statement), a connection must obtain a write-lock on <i>sqlite_master</i>. </li> <li>A connection may not compile an SQL statement if any other connection is holding a write-lock on the <i>sqlite_master</i> table of any attached database (including the default database, "main"). </li> </ul> <h1 id="thread_related_issues">
<span>3. </span>Thread Related Issues</h1> <p>In SQLite versions 3.3.0 through 3.4.2 when shared-cache mode is enabled, a database connection may only be used by the thread that called <a href="../c3ref/open/">sqlite3_open()</a> to create it. And a connection could only share cache with another connection in the same thread. These restrictions were dropped beginning with SQLite <a href="https://sqlite.org/releaselog/3_5_0.html" target="_blank">version 3.5.0</a> (2007-09-04). </p> <h1 id="shared_cache_and_virtual_tables">
<span>4. </span>Shared Cache And Virtual Tables</h1> <p> In older versions of SQLite, shared cache mode could not be used together with virtual tables. This restriction was removed in SQLite <a href="https://sqlite.org/releaselog/3_6_17.html" target="_blank">version 3.6.17</a> (2009-08-10). </p>
<h1 id="enabling_shared_cache_mode">
<span>5. </span>Enabling Shared-Cache Mode</h1> <p>Shared-cache mode is enabled on a per-process basis. Using the C interface, the following API can be used to globally enable or disable shared-cache mode: </p> <pre data-language="sql">
int sqlite3_enable_shared_cache(int);
</pre> <p>Each call to <a href="../c3ref/enable_shared_cache/">sqlite3_enable_shared_cache()</a> affects subsequent database connections created using <a href="../c3ref/open/">sqlite3_open()</a>, <a href="../c3ref/open/">sqlite3_open16()</a>, or <a href="../c3ref/open/">sqlite3_open_v2()</a>. Database connections that already exist are unaffected. Each call to <a href="../c3ref/enable_shared_cache/">sqlite3_enable_shared_cache()</a> overrides all previous calls within the same process. </p> <p>Individual database connections created using <a href="../c3ref/open/">sqlite3_open_v2()</a> can choose to participate or not participate in shared cache mode by using the <a href="../c3ref/c_open_autoproxy/">SQLITE_OPEN_SHAREDCACHE</a> or <a href="../c3ref/c_open_autoproxy/">SQLITE_OPEN_PRIVATECACHE</a> flags the third parameter. The use of either of these flags overrides the global shared cache mode setting established by <a href="../c3ref/enable_shared_cache/">sqlite3_enable_shared_cache()</a>. No more than one of the flags should be used; if both SQLITE_OPEN_SHAREDCACHE and SQLITE_OPEN_PRIVATECACHE flags are used in the third argument to <a href="../c3ref/open/">sqlite3_open_v2()</a> then the behavior is undefined.</p> <p>When <a href="../uri/">URI filenames</a> are used, the "cache" query parameter can be used to specify whether or not the database will use shared cache. Use "cache=shared" to enable shared cache and "cache=private" to disable shared cache. The ability to use URI query parameters to specify the cache sharing behavior of a database connection allows cache sharing to be controlled in <a href="../lang_attach/">ATTACH</a> statements. For example:</p> <pre data-language="sql">
ATTACH 'file:aux.db?cache=shared' AS aux;
</pre>  <h1 id="shared_cache_and_in_memory_databases">
<span>6. </span>Shared Cache And In-Memory Databases</h1> <p id="inmemsharedcache"> Beginning with SQLite <a href="https://sqlite.org/releaselog/3_7_13.html" target="_blank">version 3.7.13</a> (2012-06-11), shared cache can be used on <a href="../inmemorydb/">in-memory databases</a>, provided that the database is created using a <a href="../uri/">URI filename</a>. For backwards compatibility, shared cache is always disable for in-memory databases if the unadorned name ":memory:" is used to open the database. Prior to version 3.7.13, shared cache was always disabled for in-memory databases regardless of the database name used, current system shared cache setting, or query parameters or flags. </p> <p> Enabling shared-cache for an in-memory database allows two or more database connections in the same process to have access to the same in-memory database. An in-memory database in shared cache is automatically deleted and memory is reclaimed when the last connection to that database closes. </p>
<div class="_attribution">
  <p class="_attribution-p">
    SQLite is in the Public Domain.<br>
    <a href="https://sqlite.org/sharedcache.html" class="_attribution-link" target="_blank">https://sqlite.org/sharedcache.html</a>
  </p>
</div>

			</div>
		</div>
	</section>

	</div>
</body>
</html>
