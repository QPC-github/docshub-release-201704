
<!DOCTYPE HTML>

<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Recipe DSL - Chef 11 - W3cubDocs</title>
  
  <meta name="description" content="The Recipe DSL is a Ruby DSL that is primarily used to declare resources from within a recipe. The Recipe DSL also helps ensure that recipes &hellip;">
  <meta name="keywords" content="about, recipe, dsl, -, chef, chef~11">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="http://docs.w3cub.com/chef~11/11-18/dsl_recipe/">
  <link href="/favicon.png" rel="icon">
  <link type="text/css" rel="stylesheet" href="/assets/application-50364fff564ce3b6327021805f3f00e2957b441cf27f576a7dd4ff63bbc47047.css">
  <script type="text/javascript" src="/assets/application-db64bfd54ceb42be11af7995804cf4902548419ceb79d509b0b7d62c22d98e6f.js"></script>
  <script src="/json/chef~11.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
	<div class="_app">
	<header class="_header">
  
  <form class="_search">
    <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
    <a class="_search-clear"></a>
    <div class="_search-tag"></div>
  </form>
  
  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/chef~11/" class="_nav-link" title="" style="margin-left:0;">Chef 11</a></span>
  
  <nav class="_nav">
    <a href="/app/" class="_nav-link ">App</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		<div class="_list">
			
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<div class="_page _sphinx_simple">
				
<h1 id="about-the-recipe-dsl">About the Recipe DSL</h1> <p>The Recipe DSL is a Ruby DSL that is primarily used to declare resources from within a recipe. The Recipe DSL also helps ensure that recipes interact with nodes (and node properties) in the desired manner. Most of the methods in the Recipe DSL are used to find a specific parameter and then tell the chef-client what action(s) to take, based on whether that parameter is present on a node.</p> <p>Because the Recipe DSL is a Ruby DSL, then anything that can be done using Ruby can also be done in a recipe, including <code class="docutils literal">if</code> and <code class="docutils literal">case</code> statements, using the <code class="docutils literal">include?</code> Ruby method, including recipes in recipes, and checking for dependencies.</p>  <h2 id="use-ruby">Use Ruby</h2> <p>Common Ruby techniques can be used with the Recipe DSL methods.</p>  <h3 id="if-statements">if Statements</h3> <p>An <code class="docutils literal">if</code> statement can be used to specify part of a recipe to be used when certain conditions are met. <code class="docutils literal">else</code> and <code class="docutils literal">elseif</code> statements can be used to handle situations where either the initial condition is not met or when there are other possible conditions that can be met. Since this behavior is 100% Ruby, do this in a recipe the same way here as anywhere else.</p> <p>For example, using an <code class="docutils literal">if</code> statement with the <code class="docutils literal">platform</code> node attribute:</p> <pre class="highlight-ruby" data-language="ruby">if node['platform'] == 'ubuntu'
  # do ubuntu things
end</pre>   <h3 id="case-statements">case Statements</h3> <p>A <code class="docutils literal">case</code> statement can be used to handle a situation where there are a lot of conditions. Use the <code class="docutils literal">when</code> statement for each condition, as many as are required.</p> <p>For example, using a <code class="docutils literal">case</code> statement with the <code class="docutils literal">platform</code> node attribute:</p> <pre class="highlight-ruby" data-language="ruby">case node['platform']
when 'debian', 'ubuntu'
  # do debian/ubuntu things
when 'redhat', 'centos', 'fedora'
  # do redhat/centos/fedora things
end</pre> <p>For example, using a <code class="docutils literal">case</code> statement with the <code class="docutils literal">platform_family</code> node attribute:</p> <pre class="highlight-ruby" data-language="ruby">case node['platform_family']
when 'debian'
  # do things on debian-ish platforms (debian, ubuntu, linuxmint)
when 'rhel'
  # do things on RHEL platforms (redhat, centos, scientific, etc)
end</pre>   <h3 id="include-method">include? Method</h3> <p>The <code class="docutils literal">include?</code> method can be used to ensure that a specific parameter is included before an action is taken. For example, using the <code class="docutils literal">include?</code> method to find a specific parameter:</p> <pre class="highlight-ruby" data-language="ruby">if ['debian', 'ubuntu'].include?(node['platform'])
  # do debian/ubuntu things
end</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">if %w{rhel}.include?(node['platform_family'])
  # do RHEL things
end</pre>   <h3 id="array-syntax-shortcut">Array Syntax Shortcut</h3> <p>The <code class="docutils literal">%w</code> syntax is a Ruby shortcut for creating an array without requiring quotes and commas around the elements.</p> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">if %w{debian ubuntu}.include?(node['platform'])
  # do debian/ubuntu things with the Ruby array %w{} shortcut
end</pre>    <h2 id="include-recipes">Include Recipes</h2> <p>A recipe can include one (or more) recipes located in external cookbooks by using the <code class="docutils literal">include_recipe</code> method. When a recipe is included, the resources found in that recipe will be inserted (in the same exact order) at the point where the <code class="docutils literal">include_recipe</code> keyword is located.</p> <p>The syntax for including a recipe is like this:</p> <pre class="highlight-ruby" data-language="ruby">include_recipe 'recipe'</pre> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">include_recipe 'apache2::mod_ssl'</pre> <p>If the <code class="docutils literal">include_recipe</code> method is used more than once to include a recipe, only the first inclusion is processed and any subsequent inclusions are ignored.</p>  <h3 id="reload-attributes">Reload Attributes</h3> <p>Attributes sometimes depend on actions taken from within recipes, so it may be necessary to reload a given attribute from within a recipe. For example:</p> <pre class="highlight-ruby" data-language="ruby">ruby_block 'some_code' do
  block do
    node.from_file(run_context.resolve_attribute('COOKBOOK_NAME', 'ATTR_FILE'))
  end
  action :nothing
end</pre>   <h3 id="accessor-methods">Accessor Methods</h3> <p>Attribute accessor methods are automatically created and the method invocation can be used interchangeably with the keys. For example:</p> <pre class="highlight-ruby" data-language="ruby">default.apache.dir          = '/etc/apache2'
default.apache.listen_ports = [ '80','443' ]</pre> <p>This is a matter of style and preference for how attributes are reloaded from recipes, and may be seen when retrieving the value of an attribute.</p>    <h2 id="dsl-recipe-methods">Recipe DSL Methods</h2> <p>The Recipe DSL provides support for using attributes, data bags (and encrypted data), and search results in a recipe, as well as four helper methods that can be used to check for a node’s platform from the recipe to ensure that specific actions are taken for specific platforms. The helper methods are:</p> <ul class="simple"> <li><code class="docutils literal">platform?</code></li> <li><code class="docutils literal">platform_family?</code></li> <li><code class="docutils literal">value_for_platform</code></li> <li><code class="docutils literal">value_for_platform_family</code></li> </ul>  <h3 id="attribute">attribute?</h3> <p>Use the <code class="docutils literal">attribute?</code> method to ensure that certain actions only execute in the presence of a particular node attribute. The <code class="docutils literal">attribute?</code> method will return true if one of the listed node attributes matches a node attribute that is detected by Ohai during every chef-client run.</p> <p>The syntax for the <code class="docutils literal">attribute?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">attribute?('name_of_attribute')</pre> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">if node.attribute?('ipaddress')
  # the node has an ipaddress
end</pre>   <h3 id="cookbook-name">cookbook_name</h3> <p>Use the <code class="docutils literal">cookbook_name</code> method to return the name of a cookbook.</p> <p>The syntax for the <code class="docutils literal">cookbook_name</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">cookbook_name</pre> <p>This method is often used as part of a log entry. For example:</p> <pre class="highlight-ruby" data-language="ruby">Chef::Log.info('I am a message from the #{recipe_name} recipe in the #{cookbook_name} cookbook.')</pre>   <h3 id="data-bag">data_bag</h3> <p>A data bag is a global variable that is stored as JSON data and is accessible from a Chef server. A data bag is indexed for searching and can be loaded by a recipe or accessed during a search.</p> <p>Use the <code class="docutils literal">data_bag</code> method to get a list of the contents of a data bag.</p> <p>The syntax for the <code class="docutils literal">data_bag</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">data_bag(bag_name)</pre> <p><strong>Examples</strong></p> <p>The following example shows how the <code class="docutils literal">data_bag</code> method can be used in a recipe.</p> <p><strong>Get a data bag, and then iterate through each data bag item</strong></p> <pre class="highlight-ruby" data-language="ruby">data_bag('users') #=&gt; ['sandy', 'jill']</pre> <p>Iterate over the contents of the data bag to get the associated <code class="docutils literal">data_bag_item</code>:</p> <pre class="highlight-ruby" data-language="ruby">data_bag('users').each do |user|
  data_bag_item('users', user)
end</pre> <p>The <code class="docutils literal">id</code> for each data bag item will be returned as a string.</p>   <h3 id="data-bag-item">data_bag_item</h3> <p>A data bag is a global variable that is stored as JSON data and is accessible from a Chef server. A data bag is indexed for searching and can be loaded by a recipe or accessed during a search.</p> <p>The <code class="docutils literal">data_bag_item</code> method can be used in a recipe to get the contents of a data bag item.</p> <p>The syntax for the <code class="docutils literal">data_bag_item</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">data_bag_item(bag_name, item, secret)</pre> <p>where <code class="docutils literal">secret</code> is the secret used to load an encrypted data bag. If <code class="docutils literal">secret</code> is not specified, the chef-client looks for a secret at the path specified by the <code class="docutils literal">encrypted_data_bag_secret</code> setting in the client.rb file.</p> <p><strong>Examples</strong></p> <p>The following examples show how the <code class="docutils literal">data_bag_item</code> method can be used in a recipe.</p> <p><strong>Get a data bag, and then iterate through each data bag item</strong></p> <pre class="highlight-ruby" data-language="ruby">data_bag('users') #=&gt; ['sandy', 'jill']</pre> <p>Iterate over the contents of the data bag to get the associated <code class="docutils literal">data_bag_item</code>:</p> <pre class="highlight-ruby" data-language="ruby">data_bag('users').each do |user|
  data_bag_item('users', user)
end</pre> <p>The <code class="docutils literal">id</code> for each data bag item will be returned as a string.</p> <p><strong>Use the contents of a data bag in a recipe</strong></p> <p>The following example shows how to use the <code class="docutils literal">data_bag</code> and <code class="docutils literal">data_bag_item</code> methods in a recipe, also using a data bag named <code class="docutils literal">sea-power</code>):</p> <pre class="highlight-ruby" data-language="ruby">package 'sea-power' do
  action :install
end

directory node['sea-power']['base_path'] do
  # attributes for owner, group, mode
end

gale_warnings = data_bag('sea-power').map do |viking_north|
  data_bag_item('sea-power', viking_north)['source']
end

template '/etc/seattle/power.list' do
  source 'seattle-power.erb'
  # attributes for owner, group, mode
  variables(
    :base_path =&gt; node['sea-power']['base_path'],
    # more variables
    :repo_location =&gt; gale_warnings
  )
end</pre> <p>For a more complete version of the previous example, see the default recipe in the <a class="reference external" href="https://github.com/hw-cookbooks/apt-mirror" target="_blank">https://github.com/hw-cookbooks/apt-mirror</a> community cookbook.</p>   <h3 id="platform">platform?</h3> <p>Use the <code class="docutils literal">platform?</code> method to ensure that certain actions are run for specific platform. The <code class="docutils literal">platform?</code> method will return true if one of the listed parameters matches the <code class="docutils literal">node['platform']</code> attribute that is detected by Ohai during every chef-client run.</p> <p>The syntax for the <code class="docutils literal">platform?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">platform?('parameter', 'parameter')</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">parameter</code> is a comma-separated list, each specifying a platform, such as Red Hat, CentOS, or Fedora</li> <li>
<code class="docutils literal">platform?</code> method is typically used with an <code class="docutils literal">if</code>, <code class="docutils literal">elseif</code>, or <code class="docutils literal">case</code> statement that contains Ruby code that is specific for the platform, if detected</li> </ul>  <h4 id="parameters">Parameters</h4> <p>The following parameters can be used with this method:</p> <table class="docutils"> <colgroup> <col width="17%"> <col width="83%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Parameter</th> <th class="head">Platforms</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">aix</code></td> <td>AIX. All platform variants of AIX return <code class="docutils literal">aix</code>.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">arch</code></td> <td>Arch Linux</td> </tr> <tr class="row-even">
<td><code class="docutils literal">debian</code></td> <td>Debian, Linux Mint, Ubuntu</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">fedora</code></td> <td>Fedora</td> </tr> <tr class="row-even">
<td><code class="docutils literal">freebsd</code></td> <td>FreeBSD. All platform variants of FreeBSD return <code class="docutils literal">freebsd</code>.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">gentoo</code></td> <td>Gentoo</td> </tr> <tr class="row-even">
<td><code class="docutils literal">hpux</code></td> <td>HP-UX. All platform variants of HP-UX return <code class="docutils literal">hpux</code>.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">mac_os_x</code></td> <td>Mac OS X</td> </tr> <tr class="row-even">
<td><code class="docutils literal">netbsd</code></td> <td>NetBSD. All platform variants of NetBSD return <code class="docutils literal">netbsd</code>.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">openbsd</code></td> <td>OpenBSD. All platform variants of OpenBSD return <code class="docutils literal">openbsd</code>.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">slackware</code></td> <td>Slackware</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">solaris</code></td> <td>Solaris. For Solaris-related platforms, the <code class="docutils literal">platform_family</code> method does not support the Solaris platform family and will default back to <code class="docutils literal">platform_family = platform</code>. For example, if the platform is OmniOS, the <code class="docutils literal">platform_family</code> is <code class="docutils literal">omnios</code>, if the platform is SmartOS, the <code class="docutils literal">platform_family</code> is <code class="docutils literal">smartos</code>, and so on. All platform variants of Solaris return <code class="docutils literal">solaris</code>.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">suse</code></td> <td>openSUSE, SUSE Enterprise Linux Server.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">windows</code></td> <td>Microsoft Windows. All platform variants of Microsoft Windows return <code class="docutils literal">windows</code>.</td> </tr> </tbody> </table> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">Ohai collects platform information at the start of the chef-client run and stores that information in the <code class="docutils literal">node['platform']</code> attribute.</p> </div> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">platform?('debian')</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">platform?('rhel', 'debian')</pre>   <h4 id="examples">Examples</h4> <p>The following example shows how the <code class="docutils literal">platform?</code> method can be used in a recipe.</p> <p><strong>Use an if statement with the platform recipe DSL method</strong></p> <p>The following example shows how an if statement can be used with the <code class="docutils literal">platform?</code> method in the Recipe DSL to run code specific to Microsoft Windows. The code is defined using the <strong>ruby_block</strong> resource:</p> <pre class="highlight-ruby" data-language="ruby"># the following code sample comes from the ``client`` recipe
# in the following cookbook: https://github.com/chef-cookbooks/mysql

if platform?('windows')
  ruby_block 'copy libmysql.dll into ruby path' do
    block do
      require 'fileutils'
      FileUtils.cp "#{node['mysql']['client']['lib_dir']}\\libmysql.dll",
        node['mysql']['client']['ruby_dir']
    end
    not_if { File.exist?("#{node['mysql']['client']['ruby_dir']}\\libmysql.dll") }
  end
end</pre>    <h3 id="platform-family">platform_family?</h3> <p>Use the <code class="docutils literal">platform_family?</code> method to ensure that certain actions are run for specific platform family. The <code class="docutils literal">platform_family?</code> method will return true if one of the listed parameters matches the <code class="docutils literal">node['platform_family']</code> attribute that is detected by Ohai during every chef-client run.</p> <p>The syntax for the <code class="docutils literal">platform_family?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">platform_family?('parameter', 'parameter')</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">'parameter'</code> is a comma-separated list, each specifying a platform family, such as Debian, or Red Hat Enterprise Linux</li> <li>
<code class="docutils literal">platform_family?</code> method is typically used with an <code class="docutils literal">if</code>, <code class="docutils literal">elseif</code>, or <code class="docutils literal">case</code> statement that contains Ruby code that is specific for the platform family, if detected</li> </ul> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">if platform_family?('rhel')
  # do RHEL things
end</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">if platform_family?('debian', 'rhel')
  # do things on debian and rhel families
end</pre> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">platform_family?('gentoo')</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">platform_family?('slackware', 'suse', 'arch')</pre> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last"><code class="docutils literal">platform_family?</code> will default to <code class="docutils literal">platform?</code> when <code class="docutils literal">platform_family?</code> is not explicitly defined.</p> </div>  <h4 id="id1">Examples</h4> <p>The following examples show how the <code class="docutils literal">platform_family?</code> method can be used in a recipe.</p> <p><strong>Use a specific binary for a specific platform</strong></p> <p>The following is an example of using the <code class="docutils literal">platform_family?</code> method in the Recipe DSL to create a variable that can be used with other resources in the same recipe. In this example, <code class="docutils literal">platform_family?</code> is being used to ensure that a specific binary is used for a specific platform before using the <strong>remote_file</strong> resource to download a file from a remote location, and then using the <strong>execute</strong> resource to install that file by running a command.</p> <pre class="highlight-ruby" data-language="ruby">if platform_family?('rhel')
  pip_binary = '/usr/bin/pip'
else
  pip_binary = '/usr/local/bin/pip'
end

remote_file "#{Chef::Config[:file_cache_path]}/distribute_setup.py" do
  source 'http://python-distribute.org/distribute_setup.py'
  mode '0755'
  not_if { File.exist?(pip_binary) }
end

execute 'install-pip' do
  cwd Chef::Config[:file_cache_path]
  command &lt;&lt;-EOF
    # command for installing Python goes here
    EOF
  not_if { File.exists?(pip_binary) }
end</pre> <p>where a command for installing Python might look something like:</p> <pre class="highlight-ruby" data-language="ruby">#{node['python']['binary']} distribute_setup.py
#{::File.dirname(pip_binary)}/easy_install pip</pre>    <h3 id="reboot-pending">reboot_pending?</h3> <p>Use the <code class="docutils literal">reboot_pending?</code> method to test if a node needs a reboot, or is expected to reboot. <code class="docutils literal">reboot_pending?</code> returns <code class="docutils literal">true</code> when the node needs a reboot.</p> <p>The syntax for the <code class="docutils literal">reboot_pending?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">reboot_pending?</pre>   <h3 id="recipe-name">recipe_name</h3> <p>Use the <code class="docutils literal">recipe_name</code> method to return the name of a recipe.</p> <p>The syntax for the <code class="docutils literal">recipe_name</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">recipe_name</pre> <p>This method is often used as part of a log entry. For example:</p> <pre class="highlight-ruby" data-language="ruby">Chef::Log.info('I am a message from the #{recipe_name} recipe in the #{cookbook_name} cookbook.')</pre>   <h3 id="resources">resources</h3> <p>Use the <code class="docutils literal">resources</code> method to look up a resource in the resource collection. The <code class="docutils literal">resources</code> method returns the value for the resource that it finds in the resource collection. The preferred syntax for the <code class="docutils literal">resources</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">resources('resource_type[resource_name]')</pre> <p>but the following syntax can also be used:</p> <pre class="highlight-ruby" data-language="ruby">resources(:resource_type =&gt; 'resource_name')</pre> <p>where in either approach <code class="docutils literal">resource_type</code> is the name of a resource and <code class="docutils literal">resource_name</code> is the name of a resource that can be configured by the chef-client.</p> <p>The <code class="docutils literal">resources</code> method can be used to modify a resource later on in a recipe. For example:</p> <pre class="highlight-ruby" data-language="ruby">file '/etc/hosts' do
  content '127.0.0.1 localhost.localdomain localhost'
end</pre> <p>and then later in the same recipe, or elsewhere:</p> <pre class="highlight-ruby" data-language="ruby">f = resources('file[/etc/hosts]')
f.mode '0644'</pre> <p>where <code class="docutils literal">file</code> is the type of resource, <code class="docutils literal">/etc/hosts</code> is the name, and <code class="docutils literal">f.mode</code> is used to set the <code class="docutils literal">mode</code> property on the <strong>file</strong> resource.</p>   <h3 id="search">search</h3> <p>Search indexes allow queries to be made for any type of data that is indexed by the Chef server, including data bags (and data bag items), environments, nodes, and roles. A defined query syntax is used to support search patterns like exact, wildcard, range, and fuzzy. A search is a full-text query that can be done from several locations, including from within a recipe, by using the <code class="docutils literal">search</code> subcommand in knife, the <code class="docutils literal">search</code> method in the Recipe DSL, the search box in the Chef management console, and by using the <code class="docutils literal">/search</code> or <code class="docutils literal">/search/INDEX</code> endpoints in the Chef server API. The search engine is based on Apache Solr and is run from the Chef server.</p> <p>Use the <code class="docutils literal">search</code> method to perform a search query against the Chef server from within a recipe.</p> <p>The syntax for the <code class="docutils literal">search</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">search(:index, 'query')</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">:index</code> is of name of the index on the Chef server against which the search query will run: <code class="docutils literal">:client</code>, <code class="docutils literal">:data_bag_name</code>, <code class="docutils literal">:environment</code>, <code class="docutils literal">:node</code>, and <code class="docutils literal">:role</code>
</li> <li>
<code class="docutils literal">'query'</code> is a valid search query against an object on the Chef server (see below for more information about how to build the query)</li> </ul> <p>For example, using the results of a search query within a variable:</p> <pre class="highlight-ruby" data-language="ruby">webservers = search(:node, 'role:webserver')</pre> <p>and then using the results of that query to populate a template:</p> <pre class="highlight-ruby" data-language="ruby">template '/tmp/list_of_webservers' do
  source 'list_of_webservers.erb'
  variables(:webservers =&gt; webservers)
end</pre>  <h4 id="query-syntax">Query Syntax</h4> <p>A search query is comprised of two parts: the key and the search pattern. A search query has the following syntax:</p> <pre class="highlight-ruby" data-language="ruby">key:search_pattern</pre> <p>where <code class="docutils literal">key</code> is a field name that is found in the JSON description of an indexable object on the Chef server (a role, node, client, environment, or data bag) and <code class="docutils literal">search_pattern</code> defines what will be searched for, using one of the following search patterns: exact, wildcard, range, or fuzzy matching. Both <code class="docutils literal">key</code> and <code class="docutils literal">search_pattern</code> are case-sensitive; <code class="docutils literal">key</code> has limited support for multiple character wildcard matching using an asterisk (“*”) (and as long as it is not the first character).</p>  <h5 id="keys">Keys</h5> <p>A field name/description pair is available in the JSON object. Use the field name when searching for this information in the JSON object. Any field that exists in any JSON description for any role, node, chef-client, environment, or data bag can be searched.</p> <p><strong>Nested Fields</strong></p> <p>A nested field appears deeper in the JSON data structure. For example, information about a network interface might be several layers deep: <code class="docutils literal">node[:network][:interfaces][:en1]</code>. When nested fields are present in a JSON structure, the chef-client will extract those nested fields to the top-level, flattening them into compound fields that support wildcard search patterns.</p> <p>By combining wildcards with range-matching patterns and wildcard queries, it is possible to perform very powerful searches, such as using the vendor part of the MAC address to find every node that has a network card made by the specified vendor.</p> <p>Consider the following snippet of JSON data:</p> <pre class="highlight-javascript" data-language="javascript">{"network":
  [
  //snipped...
    "interfaces",
      {"en1": {
        "number": "1",
        "flags": [
          "UP",
          "BROADCAST",
          "SMART",
          "RUNNING",
          "SIMPLEX",
          "MULTICAST"
        ],
        "addresses": {
          "fe80::fa1e:dfff:fed8:63a2": {
            "scope": "Link",
            "prefixlen": "64",
            "family": "inet6"
          },
          "f8:1e:df:d8:63:a2": {
            "family": "lladdr"
          },
          "192.168.0.195": {
            "netmask": "255.255.255.0",
            "broadcast": "192.168.0.255",
            "family": "inet"
          }
        },
        "mtu": "1500",
        "media": {
          "supported": {
            "autoselect": {
              "options": [

              ]
            }
          },
          "selected": {
            "autoselect": {
              "options": [

              ]
            }
          }
        },
        "type": "en",
        "status": "active",
        "encapsulation": "Ethernet"
      },
  //snipped...</pre> <p>Before this data is indexed on the Chef server, the nested fields are extracted into the top level, similar to:</p> <pre class="highlight-none" data-language="none">"broadcast" =&gt; "192.168.0.255",
"flags"     =&gt; ["UP", "BROADCAST", "SMART", "RUNNING", "SIMPLEX", "MULTICAST"]
"mtu"       =&gt; "1500"</pre> <p>which allows searches like the following to find data that is present in this node:</p> <pre class="highlight-ruby" data-language="ruby">node "broadcast:192.168.0.*"</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">node "mtu:1500"</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">node "flags:UP"</pre> <p>This data is also flattened into various compound fields, which follow the same pattern as the JSON hierarchy and use underscores (<code class="docutils literal">_</code>) to separate the levels of data, similar to:</p> <pre class="highlight-none" data-language="none"># ...snip...
"network_interfaces_en1_addresses_192.168.0.195_broadcast" =&gt; "192.168.0.255",
"network_interfaces_en1_addresses_fe80::fa1e:tldr_family"  =&gt; "inet6",
"network_interfaces_en1_addresses"                         =&gt; ["fe80::fa1e:tldr","f8:1e:df:tldr","192.168.0.195"]
# ...snip...</pre> <p>which allows searches like the following to find data that is present in this node:</p> <pre class="highlight-ruby" data-language="ruby">node "network_interfaces_en1_addresses:192.168.0.195"</pre> <p>This flattened data structure also supports using wildcard compound fields, which allow searches to omit levels within the JSON data structure that are not important to the search query. In the following example, an asterisk (<code class="docutils literal">*</code>) is used to show where the wildcard can exist when searching for a nested field:</p> <pre class="highlight-ruby" data-language="ruby">"network_interfaces_*_flags"     =&gt; ["UP", "BROADCAST", "SMART", "RUNNING", "SIMPLEX", "MULTICAST"]
"network_interfaces_*_addresses" =&gt; ["fe80::fa1e:dfff:fed8:63a2", "192.168.0.195", "f8:1e:df:d8:63:a2"]
"network_interfaces_en0_media_*" =&gt; ["autoselect", "none", "1000baseT", "10baseT/UTP", "100baseTX"]
"network_interfaces_en1_*"       =&gt; ["1", "UP", "BROADCAST", "SMART", "RUNNING", "SIMPLEX", "MULTICAST",
                                     "fe80::fa1e:dfff:fed8:63a2", "f8:1e:df:d8:63:a2", "192.168.0.195",
                                     "1500", "supported", "selected", "en", "active", "Ethernet"]</pre> <p>For each of the wildcard examples above, the possible values are shown contained within the brackets. When running a search query, the query syntax for wildcards is to simply omit the name of the node (while preserving the underscores), similar to:</p> <pre class="highlight-ruby" data-language="ruby">network_interfaces__flags</pre> <p>This query will search within the <code class="docutils literal">flags</code> node, within the JSON structure, for each of <code class="docutils literal">UP</code>, <code class="docutils literal">BROADCAST</code>, <code class="docutils literal">SMART</code>, <code class="docutils literal">RUNNING</code>, <code class="docutils literal">SIMPLEX</code>, and <code class="docutils literal">MULTICAST</code>.</p>   <h5 id="patterns">Patterns</h5> <p>A search pattern is a way to fine-tune search results by returning anything that matches some type of incomplete search query. There are four types of search patterns that can be used when searching the search indexes on the Chef server: exact, wildcard, range, and fuzzy.</p> <p><strong>Exact Match</strong></p> <p>An exact matching search pattern is used to search for a key with a name that exactly matches a search query. If the name of the key contains spaces, quotes must be used in the search pattern to ensure the search query finds the key. The entire query must also be contained within quotes, so as to prevent it from being interpreted by Ruby or a command shell. The best way to ensure that quotes are used consistently is to quote the entire query using single quotes (‘ ‘) and a search pattern with double quotes (” ”).</p> <p><strong>Wildcard Match</strong></p> <p>A wildcard matching search pattern is used to query for substring matches that replace zero (or more) characters in the search pattern with anything that could match the replaced character. There are two types of wildcard searches:</p> <ul class="simple"> <li>A question mark (<code class="docutils literal">?</code>) can be used to replace exactly one character (as long as that character is not the first character in the search pattern)</li> <li>An asterisk (<code class="docutils literal">*</code>) can be used to replace any number of characters (including zero)</li> </ul> <p><strong>Range Match</strong></p> <p>A range matching search pattern is used to query for values that are within a range defined by upper and lower boundaries. A range matching search pattern can be inclusive or exclusive of the boundaries. Use square brackets (“[ ]”) to denote inclusive boundaries and curly braces (“{ }”) to denote exclusive boundaries and with the following syntax:</p> <pre class="highlight-ruby" data-language="ruby">boundary TO boundary</pre> <p>where <code class="docutils literal">TO</code> is required (and must be capitalized).</p> <p><strong>Fuzzy Match</strong></p> <p>A fuzzy matching search pattern is used to search based on the proximity of two strings of characters. An (optional) integer may be used as part of the search query to more closely define the proximity. A fuzzy matching search pattern has the following syntax:</p> <pre class="highlight-ruby" data-language="ruby">"search_query"~edit_distance</pre> <p>where <code class="docutils literal">search_query</code> is the string that will be used during the search and <code class="docutils literal">edit_distance</code> is the proximity. A tilde (“~”) is used to separate the edit distance from the search query.</p>   <h5 id="operators">Operators</h5> <p>An operator can be used to ensure that certain terms are included in the results, are excluded from the results, or are not included even when other aspects of the query match. Searches can use the following operators:</p> <table class="docutils"> <colgroup> <col width="40%"> <col width="60%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Operator</th> <th class="head">Description</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">AND</code></td> <td>Use to find a match when both terms exist.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">OR</code></td> <td>Use to find a match if either term exists.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">NOT</code></td> <td>Use to exclude the term after <code class="docutils literal">NOT</code> from the search results.</td> </tr> </tbody> </table>   <h5 id="special-characters">Special Characters</h5> <p>A special character can be used to fine-tune a search query and to increase the accuracy of the search results. The following characters can be included within the search query syntax, but each occurrence of a special character must be escaped with a backslash (<code class="docutils literal">\</code>):</p> <pre class="highlight-ruby" data-language="ruby">+  -  &amp;&amp;  | |  !  ( )  { }  [ ]  ^  "  ~  *  ?  :  \</pre> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">\(1\+1\)\:2</pre>    <h4 id="id2">Examples</h4> <p>The following examples show how the <code class="docutils literal">search</code> method can be used in a recipe.</p> <p><strong>Use the search recipe DSL method to find users</strong></p> <p>The following example shows how to use the <code class="docutils literal">search</code> method in the Recipe DSL to search for users:</p> <pre class="highlight-ruby" data-language="ruby">#  the following code sample comes from the openvpn cookbook: https://github.com/chef-cookbooks/openvpn

search("users", "*:*") do |u|
  execute "generate-openvpn-#{u['id']}" do
    command "./pkitool #{u['id']}"
    cwd '/etc/openvpn/easy-rsa'
    environment(
      'EASY_RSA' =&gt; '/etc/openvpn/easy-rsa',
      'KEY_CONFIG' =&gt; '/etc/openvpn/easy-rsa/openssl.cnf',
      'KEY_DIR' =&gt; node['openvpn']['key_dir'],
      'CA_EXPIRE' =&gt; node['openvpn']['key']['ca_expire'].to_s,
      'KEY_EXPIRE' =&gt; node['openvpn']['key']['expire'].to_s,
      'KEY_SIZE' =&gt; node['openvpn']['key']['size'].to_s,
      'KEY_COUNTRY' =&gt; node['openvpn']['key']['country'],
      'KEY_PROVINCE' =&gt; node['openvpn']['key']['province'],
      'KEY_CITY' =&gt; node['openvpn']['key']['city'],
      'KEY_ORG' =&gt; node['openvpn']['key']['org'],
      'KEY_EMAIL' =&gt; node['openvpn']['key']['email']
    )
    not_if { File.exist?("#{node['openvpn']['key_dir']}/#{u['id']}.crt") }
  end

  %w{ conf ovpn }.each do |ext|
    template "#{node['openvpn']['key_dir']}/#{u['id']}.#{ext}" do
      source 'client.conf.erb'
      variables :username =&gt; u['id']
    end
  end

  execute "create-openvpn-tar-#{u['id']}" do
    cwd node['openvpn']['key_dir']
    command &lt;&lt;-EOH
      tar zcf #{u['id']}.tar.gz \
      ca.crt #{u['id']}.crt #{u['id']}.key \
      #{u['id']}.conf #{u['id']}.ovpn \
    EOH
    not_if { File.exist?("#{node['openvpn']['key_dir']}/#{u['id']}.tar.gz") }
  end
end</pre> <p>where</p> <ul class="simple"> <li>the search will use both of the <strong>execute</strong> resources, unless the condition specified by the <code class="docutils literal">not_if</code> commands are met</li> <li>the <code class="docutils literal">environments</code> property in the first <strong>execute</strong> resource is being used to define values that appear as variables in the OpenVPN configuration</li> <li>the <strong>template</strong> resource tells the chef-client which template to use</li> </ul>    <h3 id="tag-tagged-untag">tag, tagged?, untag</h3> <p>A tag is a custom description that is applied to a node. A tag, once applied, can be helpful when managing nodes using knife or when building recipes by providing alternate methods of grouping similar types of information.</p> <p>Tags can be added and removed. Machines can be checked to see if they already have a specific tag. To use tags in your recipe simply add the following:</p> <pre class="highlight-ruby" data-language="ruby">tag('mytag')</pre> <p>To test if a machine is tagged, add the following:</p> <pre class="highlight-ruby" data-language="ruby">tagged?('mytag')</pre> <p>to return <code class="docutils literal">true</code> or <code class="docutils literal">false</code>. <code class="docutils literal">tagged?</code> can also use an array as an argument.</p> <p>To remove a tag:</p> <pre class="highlight-ruby" data-language="ruby">untag('mytag')</pre> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">tag('machine')

if tagged?('machine')
   Chef::Log.info('Hey I'm #{node[:tags]}')
end

untag('machine')

if not tagged?('machine')
   Chef::Log.info('I has no tagz')
end</pre> <p>Will return something like this:</p> <pre class="highlight-none" data-language="none">[Thu, 22 Jul 2010 18:01:45 +0000] INFO: Hey I'm machine
[Thu, 22 Jul 2010 18:01:45 +0000] INFO: I has no tagz</pre>   <h3 id="value-for-platform">value_for_platform</h3> <p>Use the <code class="docutils literal">value_for_platform</code> method in a recipe to select a value based on the <code class="docutils literal">node['platform']</code> and <code class="docutils literal">node['platform_version']</code> attributes. These values are detected by Ohai during every chef-client run.</p> <p>The syntax for the <code class="docutils literal">value_for_platform</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">value_for_platform( ['platform', ...] =&gt; { 'version' =&gt; 'value' } )</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">'platform', ...</code> is a comma-separated list of platforms, such as Red Hat, openSUSE, or Fedora</li> <li>
<code class="docutils literal">version</code> specifies the version of that platform</li> <li>Version constraints—<code class="docutils literal">&gt;</code>, <code class="docutils literal">&lt;</code>, <code class="docutils literal">&gt;=</code>, <code class="docutils literal">&lt;=</code>, <code class="docutils literal">~&gt;</code>—may be used with <code class="docutils literal">version</code>; an exception is raised if two version constraints match; an exact match will always take precedence over a match made from a version constraint</li> <li>
<code class="docutils literal">value</code> specifies the value that will be used if the node’s platform matches the <code class="docutils literal">value_for_platform</code> method</li> </ul> <p>When each value only has a single platform, use the following syntax:</p> <pre class="highlight-ruby" data-language="ruby">value_for_platform(
  'platform' =&gt; { 'version' =&gt; 'value' },
  'platform' =&gt; { 'version' =&gt; 'value' },
  'platform' =&gt; 'value'
)</pre> <p>When each value has more than one platform, the syntax changes to:</p> <pre class="highlight-ruby" data-language="ruby">value_for_platform(
  ['platform', 'platform', ... ] =&gt; {
    'version' =&gt; 'value'
  },
)</pre>  <h4 id="id3">Operators</h4> <p>The following operators may be used:</p> <table class="docutils"> <colgroup> <col width="40%"> <col width="60%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Operator</th> <th class="head">Description</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">=</code></td> <td>equal to</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">&gt;</code></td> <td>greater than</td> </tr> <tr class="row-even">
<td><code class="docutils literal">&lt;</code></td> <td>less than</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">&gt;=</code></td> <td>greater than or equal to; also known as “optimistically greater than”, or “optimistic”</td> </tr> <tr class="row-even">
<td><code class="docutils literal">&lt;=</code></td> <td>less than or equal to</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">~&gt;</code></td> <td>approximately greater than; also known as “pessimistically greater than”, or “pessimistic”</td> </tr> </tbody> </table>   <h4 id="id4">Examples</h4> <p>The following example will set <code class="docutils literal">package_name</code> to <code class="docutils literal">httpd</code> for the Red Hat platform and to <code class="docutils literal">apache2</code> for the Debian platform:</p> <pre class="highlight-ruby" data-language="ruby">package_name = value_for_platform(
  ['centos', 'redhat', 'suse', 'fedora' ] =&gt; {
    'default' =&gt; 'httpd'
  },
  ['ubuntu', 'debian'] =&gt; {
    'default' =&gt; 'apache2'
  }
)</pre> <p>The following example will set <code class="docutils literal">package</code> to <code class="docutils literal">apache-couchdb</code> for OpenBSD platforms, <code class="docutils literal">dev-db/couchdb</code> for Gentoo platforms, and <code class="docutils literal">couchdb</code> for all other platforms:</p> <pre class="highlight-ruby" data-language="ruby">package = value_for_platform(
  'openbsd' =&gt; { 'default' =&gt; 'apache-couchdb' },
  'gentoo' =&gt; { 'default' =&gt; 'dev-db/couchdb' },
  'default' =&gt; 'couchdb'
)</pre> <p>The following example shows using version constraints to specify a value based on the version:</p> <pre class="highlight-ruby" data-language="ruby">value_for_platform(
  'os1' =&gt; { '&lt; 1.0' =&gt; 'less than 1.0',
             '~&gt; 2.0' =&gt; 'version 2.x',
             '&gt;= 3.0' =&gt; 'version 3.0',
             '3.0.1' =&gt; '3.0.1 will always use this value' }
)</pre>    <h3 id="value-for-platform-family">value_for_platform_family</h3> <p>Use the <code class="docutils literal">value_for_platform_family</code> method in a recipe to select a value based on the <code class="docutils literal">node['platform_family']</code> attribute. This value is detected by Ohai during every chef-client run.</p> <p>The syntax for the <code class="docutils literal">value_for_platform_family</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">value_for_platform_family( 'platform_family' =&gt; { 'version' =&gt; 'value' }, ... )</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">'platform_family' =&gt; { 'version' =&gt; 'value' }, ...</code> is a comma-separated list of platforms, such as Fedora, openSUSE, or Red Hat Enterprise Linux</li> <li>
<code class="docutils literal">value</code> specifies the value that will be used if the node’s platform family matches the <code class="docutils literal">value_for_platform_family</code> method</li> </ul> <p>When each value only has a single platform, use the following syntax:</p> <pre class="highlight-ruby" data-language="ruby">value_for_platform_family(
  'platform_family' =&gt; { 'version' =&gt; 'value' },
  'platform_family' =&gt; { 'version' =&gt; 'value' },
  'platform_family' =&gt; 'value'
)</pre> <p>When each value has more than one platform, the syntax changes to:</p> <pre class="highlight-ruby" data-language="ruby">value_for_platform_family(
  ['platform_family', 'platform_family', 'platform_family', 'platform_family' ] =&gt; 'value',
  ['platform_family', 'platform_family'] =&gt; 'value',
  'default' =&gt; 'value'
)</pre> <p>The following example will set <code class="docutils literal">package</code> to <code class="docutils literal">httpd-devel</code> for the Red Hat Enterprise Linux, Fedora, and openSUSE platforms and to <code class="docutils literal">apache2-dev</code> for the Debian platform:</p> <pre class="highlight-ruby" data-language="ruby">package = value_for_platform_family(
  ['rhel', 'fedora', 'suse'] =&gt; 'httpd-devel',
    'debian' =&gt; 'apache2-dev'
)</pre>    <h2 id="windows-platform">Windows Platform</h2> <p>Six methods are present in the Recipe DSL to help verify the registry during a chef-client run on the Microsoft Windows platform—<code class="docutils literal">registry_data_exists?</code>, <code class="docutils literal">registry_get_subkeys</code>, <code class="docutils literal">registry_get_values</code>, <code class="docutils literal">registry_has_subkeys?</code>, <code class="docutils literal">registry_key_exists?</code>, and <code class="docutils literal">registry_value_exists?</code>—these helpers ensure the <strong>powershell_script</strong> resource is idempotent.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The recommended order in which registry key-specific methods should be used within a recipe is: <code class="docutils literal">key_exists?</code>, <code class="docutils literal">value_exists?</code>, <code class="docutils literal">data_exists?</code>, <code class="docutils literal">get_values</code>, <code class="docutils literal">has_subkeys?</code>, and then <code class="docutils literal">get_subkeys</code>.</p> </div>  <h3 id="registry-data-exists">registry_data_exists?</h3> <p>Use the <code class="docutils literal">registry_data_exists?</code> method to find out if a Microsoft Windows registry key contains the specified data of the specified type under the value.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This method can be used in recipes and from within the <code class="docutils literal">not_if</code> and <code class="docutils literal">only_if</code> blocks in resources. This method is not designed to create or modify a registry key. If a registry key needs to be modified, use the <strong>registry_key</strong> resource.</p> </div> <p>The syntax for the <code class="docutils literal">registry_data_exists?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">registry_data_exists?(
  KEY_PATH,
  { :name =&gt; 'NAME', :type =&gt; TYPE, :data =&gt; DATA },
  ARCHITECTURE
)</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">KEY_PATH</code> is the path to the registry key value. The path must include the registry hive, which can be specified either as its full name or as the 3- or 4-letter abbreviation. For example, both <code class="docutils literal">HKLM\SECURITY</code> and <code class="docutils literal">HKEY_LOCAL_MACHINE\SECURITY</code> are both valid and equivalent. The following hives are valid: <code class="docutils literal">HKEY_LOCAL_MACHINE</code>, <code class="docutils literal">HKLM</code>, <code class="docutils literal">HKEY_CURRENT_CONFIG</code>, <code class="docutils literal">HKCC</code>, <code class="docutils literal">HKEY_CLASSES_ROOT</code>, <code class="docutils literal">HKCR</code>, <code class="docutils literal">HKEY_USERS</code>, <code class="docutils literal">HKU</code>, <code class="docutils literal">HKEY_CURRENT_USER</code>, and <code class="docutils literal">HKCU</code>.</li> <li>
<code class="docutils literal">{ :name =&gt; 'NAME', :type =&gt; TYPE, :data =&gt; DATA }</code> is a hash that contains the expected name, type, and data of the registry key value</li> <li>
<code class="docutils literal">:type</code> represents the values available for registry keys in Microsoft Windows. Use <code class="docutils literal">:binary</code> for REG_BINARY, <code class="docutils literal">:string</code> for REG_SZ, <code class="docutils literal">:multi_string</code> for REG_MULTI_SZ, <code class="docutils literal">:expand_string</code> for REG_EXPAND_SZ, <code class="docutils literal">:dword</code> for REG_DWORD, <code class="docutils literal">:dword_big_endian</code> for REG_DWORD_BIG_ENDIAN, or <code class="docutils literal">:qword</code> for REG_QWORD.</li> <li>
<code class="docutils literal">ARCHITECTURE</code> is one of the following values: <code class="docutils literal">:x86_64</code>, <code class="docutils literal">:i386</code>, or <code class="docutils literal">:machine</code>. In order to read or write 32-bit registry keys on 64-bit machines running Microsoft Windows, the <code class="docutils literal">architecture</code> property must be set to <code class="docutils literal">:i386</code>. The <code class="docutils literal">:x86_64</code> value can be used to force writing to a 64-bit registry location, but this value is less useful than the default (<code class="docutils literal">:machine</code>) because the chef-client returns an exception if <code class="docutils literal">:x86_64</code> is used and the machine turns out to be a 32-bit machine (whereas with <code class="docutils literal">:machine</code>, the chef-client is able to access the registry key on the 32-bit machine).</li> </ul> <p>This method will return <code class="docutils literal">true</code> or <code class="docutils literal">false</code>.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The <code class="docutils literal">ARCHITECTURE</code> attribute should only specify <code class="docutils literal">:x86_64</code> or <code class="docutils literal">:i386</code> when it is necessary to write 32-bit (<code class="docutils literal">:i386</code>) or 64-bit (<code class="docutils literal">:x86_64</code>) values on a 64-bit machine. <code class="docutils literal">ARCHITECTURE</code> will default to <code class="docutils literal">:machine</code> unless a specific value is given.</p> </div>   <h3 id="registry-get-subkeys">registry_get_subkeys</h3> <p>Use the <code class="docutils literal">registry_get_subkeys</code> method to get a list of registry key values that are present for a Microsoft Windows registry key.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This method can be used in recipes and from within the <code class="docutils literal">not_if</code> and <code class="docutils literal">only_if</code> blocks in resources. This method is not designed to create or modify a registry key. If a registry key needs to be modified, use the <strong>registry_key</strong> resource.</p> </div> <p>The syntax for the <code class="docutils literal">registry_get_subkeys</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">subkey_array = registry_get_subkeys(KEY_PATH, ARCHITECTURE)</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">KEY_PATH</code> is the path to the registry key. The path must include the registry hive, which can be specified either as its full name or as the 3- or 4-letter abbreviation. For example, both <code class="docutils literal">HKLM\SECURITY</code> and <code class="docutils literal">HKEY_LOCAL_MACHINE\SECURITY</code> are both valid and equivalent. The following hives are valid: <code class="docutils literal">HKEY_LOCAL_MACHINE</code>, <code class="docutils literal">HKLM</code>, <code class="docutils literal">HKEY_CURRENT_CONFIG</code>, <code class="docutils literal">HKCC</code>, <code class="docutils literal">HKEY_CLASSES_ROOT</code>, <code class="docutils literal">HKCR</code>, <code class="docutils literal">HKEY_USERS</code>, <code class="docutils literal">HKU</code>, <code class="docutils literal">HKEY_CURRENT_USER</code>, and <code class="docutils literal">HKCU</code>.</li> <li>
<code class="docutils literal">ARCHITECTURE</code> is one of the following values: <code class="docutils literal">:x86_64</code>, <code class="docutils literal">:i386</code>, or <code class="docutils literal">:machine</code>. In order to read or write 32-bit registry keys on 64-bit machines running Microsoft Windows, the <code class="docutils literal">architecture</code> property must be set to <code class="docutils literal">:i386</code>. The <code class="docutils literal">:x86_64</code> value can be used to force writing to a 64-bit registry location, but this value is less useful than the default (<code class="docutils literal">:machine</code>) because the chef-client returns an exception if <code class="docutils literal">:x86_64</code> is used and the machine turns out to be a 32-bit machine (whereas with <code class="docutils literal">:machine</code>, the chef-client is able to access the registry key on the 32-bit machine).</li> </ul> <p>This returns an array of registry key values.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The <code class="docutils literal">ARCHITECTURE</code> attribute should only specify <code class="docutils literal">:x86_64</code> or <code class="docutils literal">:i386</code> when it is necessary to write 32-bit (<code class="docutils literal">:i386</code>) or 64-bit (<code class="docutils literal">:x86_64</code>) values on a 64-bit machine. <code class="docutils literal">ARCHITECTURE</code> will default to <code class="docutils literal">:machine</code> unless a specific value is given.</p> </div>   <h3 id="registry-get-values">registry_get_values</h3> <p>Use the <code class="docutils literal">registry_get_values</code> method to get the registry key values (name, type, and data) for a Microsoft Windows registry key.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This method can be used in recipes and from within the <code class="docutils literal">not_if</code> and <code class="docutils literal">only_if</code> blocks in resources. This method is not designed to create or modify a registry key. If a registry key needs to be modified, use the <strong>registry_key</strong> resource.</p> </div> <p>The syntax for the <code class="docutils literal">registry_get_values</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">subkey_array = registry_get_values(KEY_PATH, ARCHITECTURE)</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">KEY_PATH</code> is the path to the registry key. The path must include the registry hive, which can be specified either as its full name or as the 3- or 4-letter abbreviation. For example, both <code class="docutils literal">HKLM\SECURITY</code> and <code class="docutils literal">HKEY_LOCAL_MACHINE\SECURITY</code> are both valid and equivalent. The following hives are valid: <code class="docutils literal">HKEY_LOCAL_MACHINE</code>, <code class="docutils literal">HKLM</code>, <code class="docutils literal">HKEY_CURRENT_CONFIG</code>, <code class="docutils literal">HKCC</code>, <code class="docutils literal">HKEY_CLASSES_ROOT</code>, <code class="docutils literal">HKCR</code>, <code class="docutils literal">HKEY_USERS</code>, <code class="docutils literal">HKU</code>, <code class="docutils literal">HKEY_CURRENT_USER</code>, and <code class="docutils literal">HKCU</code>.</li> <li>
<code class="docutils literal">ARCHITECTURE</code> is one of the following values: <code class="docutils literal">:x86_64</code>, <code class="docutils literal">:i386</code>, or <code class="docutils literal">:machine</code>. In order to read or write 32-bit registry keys on 64-bit machines running Microsoft Windows, the <code class="docutils literal">architecture</code> property must be set to <code class="docutils literal">:i386</code>. The <code class="docutils literal">:x86_64</code> value can be used to force writing to a 64-bit registry location, but this value is less useful than the default (<code class="docutils literal">:machine</code>) because the chef-client returns an exception if <code class="docutils literal">:x86_64</code> is used and the machine turns out to be a 32-bit machine (whereas with <code class="docutils literal">:machine</code>, the chef-client is able to access the registry key on the 32-bit machine).</li> </ul> <p>This returns an array of registry key values.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The <code class="docutils literal">ARCHITECTURE</code> attribute should only specify <code class="docutils literal">:x86_64</code> or <code class="docutils literal">:i386</code> when it is necessary to write 32-bit (<code class="docutils literal">:i386</code>) or 64-bit (<code class="docutils literal">:x86_64</code>) values on a 64-bit machine. <code class="docutils literal">ARCHITECTURE</code> will default to <code class="docutils literal">:machine</code> unless a specific value is given.</p> </div>   <h3 id="registry-has-subkeys">registry_has_subkeys?</h3> <p>Use the <code class="docutils literal">registry_has_subkeys?</code> method to find out if a Microsoft Windows registry key has one (or more) values.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This method can be used in recipes and from within the <code class="docutils literal">not_if</code> and <code class="docutils literal">only_if</code> blocks in resources. This method is not designed to create or modify a registry key. If a registry key needs to be modified, use the <strong>registry_key</strong> resource.</p> </div> <p>The syntax for the <code class="docutils literal">registry_has_subkeys?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">registry_has_subkeys?(KEY_PATH, ARCHITECTURE)</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">KEY_PATH</code> is the path to the registry key. The path must include the registry hive, which can be specified either as its full name or as the 3- or 4-letter abbreviation. For example, both <code class="docutils literal">HKLM\SECURITY</code> and <code class="docutils literal">HKEY_LOCAL_MACHINE\SECURITY</code> are both valid and equivalent. The following hives are valid: <code class="docutils literal">HKEY_LOCAL_MACHINE</code>, <code class="docutils literal">HKLM</code>, <code class="docutils literal">HKEY_CURRENT_CONFIG</code>, <code class="docutils literal">HKCC</code>, <code class="docutils literal">HKEY_CLASSES_ROOT</code>, <code class="docutils literal">HKCR</code>, <code class="docutils literal">HKEY_USERS</code>, <code class="docutils literal">HKU</code>, <code class="docutils literal">HKEY_CURRENT_USER</code>, and <code class="docutils literal">HKCU</code>.</li> <li>
<code class="docutils literal">ARCHITECTURE</code> is one of the following values: <code class="docutils literal">:x86_64</code>, <code class="docutils literal">:i386</code>, or <code class="docutils literal">:machine</code>. In order to read or write 32-bit registry keys on 64-bit machines running Microsoft Windows, the <code class="docutils literal">architecture</code> property must be set to <code class="docutils literal">:i386</code>. The <code class="docutils literal">:x86_64</code> value can be used to force writing to a 64-bit registry location, but this value is less useful than the default (<code class="docutils literal">:machine</code>) because the chef-client returns an exception if <code class="docutils literal">:x86_64</code> is used and the machine turns out to be a 32-bit machine (whereas with <code class="docutils literal">:machine</code>, the chef-client is able to access the registry key on the 32-bit machine).</li> </ul> <p>This method will return <code class="docutils literal">true</code> or <code class="docutils literal">false</code>.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The <code class="docutils literal">ARCHITECTURE</code> attribute should only specify <code class="docutils literal">:x86_64</code> or <code class="docutils literal">:i386</code> when it is necessary to write 32-bit (<code class="docutils literal">:i386</code>) or 64-bit (<code class="docutils literal">:x86_64</code>) values on a 64-bit machine. <code class="docutils literal">ARCHITECTURE</code> will default to <code class="docutils literal">:machine</code> unless a specific value is given.</p> </div>   <h3 id="registry-key-exists">registry_key_exists?</h3> <p>Use the <code class="docutils literal">registry_key_exists?</code> method to find out if a Microsoft Windows registry key exists at the specified path.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This method can be used in recipes and from within the <code class="docutils literal">not_if</code> and <code class="docutils literal">only_if</code> blocks in resources. This method is not designed to create or modify a registry key. If a registry key needs to be modified, use the <strong>registry_key</strong> resource.</p> </div> <p>The syntax for the <code class="docutils literal">registry_key_exists?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">registry_key_exists?(KEY_PATH, ARCHITECTURE)</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">KEY_PATH</code> is the path to the registry key. The path must include the registry hive, which can be specified either as its full name or as the 3- or 4-letter abbreviation. For example, both <code class="docutils literal">HKLM\SECURITY</code> and <code class="docutils literal">HKEY_LOCAL_MACHINE\SECURITY</code> are both valid and equivalent. The following hives are valid: <code class="docutils literal">HKEY_LOCAL_MACHINE</code>, <code class="docutils literal">HKLM</code>, <code class="docutils literal">HKEY_CURRENT_CONFIG</code>, <code class="docutils literal">HKCC</code>, <code class="docutils literal">HKEY_CLASSES_ROOT</code>, <code class="docutils literal">HKCR</code>, <code class="docutils literal">HKEY_USERS</code>, <code class="docutils literal">HKU</code>, <code class="docutils literal">HKEY_CURRENT_USER</code>, and <code class="docutils literal">HKCU</code>.</li> <li>
<code class="docutils literal">ARCHITECTURE</code> is one of the following values: <code class="docutils literal">:x86_64</code>, <code class="docutils literal">:i386</code>, or <code class="docutils literal">:machine</code>. In order to read or write 32-bit registry keys on 64-bit machines running Microsoft Windows, the <code class="docutils literal">architecture</code> property must be set to <code class="docutils literal">:i386</code>. The <code class="docutils literal">:x86_64</code> value can be used to force writing to a 64-bit registry location, but this value is less useful than the default (<code class="docutils literal">:machine</code>) because the chef-client returns an exception if <code class="docutils literal">:x86_64</code> is used and the machine turns out to be a 32-bit machine (whereas with <code class="docutils literal">:machine</code>, the chef-client is able to access the registry key on the 32-bit machine).</li> </ul> <p>This method will return <code class="docutils literal">true</code> or <code class="docutils literal">false</code>. (Any registry key values that are associated with this registry key are ignored.)</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The <code class="docutils literal">ARCHITECTURE</code> attribute should only specify <code class="docutils literal">:x86_64</code> or <code class="docutils literal">:i386</code> when it is necessary to write 32-bit (<code class="docutils literal">:i386</code>) or 64-bit (<code class="docutils literal">:x86_64</code>) values on a 64-bit machine. <code class="docutils literal">ARCHITECTURE</code> will default to <code class="docutils literal">:machine</code> unless a specific value is given.</p> </div>   <h3 id="registry-value-exists">registry_value_exists?</h3> <p>Use the <code class="docutils literal">registry_value_exists?</code> method to find out if a registry key value exists. Use <code class="docutils literal">registry_data_exists?</code> to test for the type and data of a registry key value.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This method can be used in recipes and from within the <code class="docutils literal">not_if</code> and <code class="docutils literal">only_if</code> blocks in resources. This method is not designed to create or modify a registry key. If a registry key needs to be modified, use the <strong>registry_key</strong> resource.</p> </div> <p>The syntax for the <code class="docutils literal">registry_value_exists?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">registry_value_exists?(
  KEY_PATH,
  { :name =&gt; 'NAME' },
  ARCHITECTURE
)</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">KEY_PATH</code> is the path to the registry key. The path must include the registry hive, which can be specified either as its full name or as the 3- or 4-letter abbreviation. For example, both <code class="docutils literal">HKLM\SECURITY</code> and <code class="docutils literal">HKEY_LOCAL_MACHINE\SECURITY</code> are both valid and equivalent. The following hives are valid: <code class="docutils literal">HKEY_LOCAL_MACHINE</code>, <code class="docutils literal">HKLM</code>, <code class="docutils literal">HKEY_CURRENT_CONFIG</code>, <code class="docutils literal">HKCC</code>, <code class="docutils literal">HKEY_CLASSES_ROOT</code>, <code class="docutils literal">HKCR</code>, <code class="docutils literal">HKEY_USERS</code>, <code class="docutils literal">HKU</code>, <code class="docutils literal">HKEY_CURRENT_USER</code>, and <code class="docutils literal">HKCU</code>.</li> <li>
<code class="docutils literal">{ :name =&gt; 'NAME' }</code> is a hash that contains the name of the registry key value; if either <code class="docutils literal">:type</code> or <code class="docutils literal">:value</code> are specified in the hash, they are ignored</li> <li>
<code class="docutils literal">:type</code> represents the values available for registry keys in Microsoft Windows. Use <code class="docutils literal">:binary</code> for REG_BINARY, <code class="docutils literal">:string</code> for REG_SZ, <code class="docutils literal">:multi_string</code> for REG_MULTI_SZ, <code class="docutils literal">:expand_string</code> for REG_EXPAND_SZ, <code class="docutils literal">:dword</code> for REG_DWORD, <code class="docutils literal">:dword_big_endian</code> for REG_DWORD_BIG_ENDIAN, or <code class="docutils literal">:qword</code> for REG_QWORD.</li> <li>
<code class="docutils literal">ARCHITECTURE</code> is one of the following values: <code class="docutils literal">:x86_64</code>, <code class="docutils literal">:i386</code>, or <code class="docutils literal">:machine</code>. In order to read or write 32-bit registry keys on 64-bit machines running Microsoft Windows, the <code class="docutils literal">architecture</code> property must be set to <code class="docutils literal">:i386</code>. The <code class="docutils literal">:x86_64</code> value can be used to force writing to a 64-bit registry location, but this value is less useful than the default (<code class="docutils literal">:machine</code>) because the chef-client returns an exception if <code class="docutils literal">:x86_64</code> is used and the machine turns out to be a 32-bit machine (whereas with <code class="docutils literal">:machine</code>, the chef-client is able to access the registry key on the 32-bit machine).</li> </ul> <p>This method will return <code class="docutils literal">true</code> or <code class="docutils literal">false</code>.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The <code class="docutils literal">ARCHITECTURE</code> attribute should only specify <code class="docutils literal">:x86_64</code> or <code class="docutils literal">:i386</code> when it is necessary to write 32-bit (<code class="docutils literal">:i386</code>) or 64-bit (<code class="docutils literal">:x86_64</code>) values on a 64-bit machine. <code class="docutils literal">ARCHITECTURE</code> will default to <code class="docutils literal">:machine</code> unless a specific value is given.</p> </div>   <h3 id="helpers">Helpers</h3> <p>A recipe can define specific behaviors for specific Microsoft Windows platform versions by using a series of helper methods. To enable these helper methods, add the following to a recipe:</p> <pre class="highlight-ruby" data-language="ruby">require 'chef/win32/version'</pre> <p>Then declare a variable using the <code class="docutils literal">Chef::ReservedNames::Win32::Version</code> class:</p> <pre class="highlight-ruby" data-language="ruby">variable_name = Chef::ReservedNames::Win32::Version.new</pre> <p>And then use this variable to define specific behaviors for specific Microsoft Windows platform versions. For example:</p> <pre class="highlight-ruby" data-language="ruby">if variable_name.helper_name?
  # Ruby code goes here, such as
  resource_name do
    # resource block
  end

elsif variable_name.helper_name?
  # Ruby code goes here
  resource_name do
    # resource block for something else
  end

else variable_name.helper_name?
  # Ruby code goes here, such as
  log 'log entry' do
    level :level
  end

end</pre> <p>The following Microsoft Windows platform-specific helpers can be used in recipes:</p> <table class="docutils"> <colgroup> <col width="40%"> <col width="60%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Helper</th> <th class="head">Description</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">cluster?</code></td> <td>Use to test for a Cluster SKU (Windows Server 2003 and later).</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">core?</code></td> <td>Use to test for a Core SKU (Windows Server 2003 and later).</td> </tr> <tr class="row-even">
<td><code class="docutils literal">datacenter?</code></td> <td>Use to test for a Datacenter SKU.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">marketing_name</code></td> <td>Use to display the marketing name for a Microsoft Windows platform.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">windows_7?</code></td> <td>Use to test for Windows 7.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">windows_8?</code></td> <td>Use to test for Windows 8.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">windows_8_1?</code></td> <td>Use to test for Windows 8.1.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">windows_2000?</code></td> <td>Use to test for Windows 2000.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">windows_home_server?</code></td> <td>Use to test for Windows Home Server.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">windows_server_2003?</code></td> <td>Use to test for Windows Server 2003.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">windows_server_2003_r2?</code></td> <td>Use to test for Windows Server 2003 R2.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">windows_server_2008?</code></td> <td>Use to test for Windows Server 2008.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">windows_server_2008_r2?</code></td> <td>Use to test for Windows Server 2008 R2.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">windows_server_2012?</code></td> <td>Use to test for Windows Server 2012.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">windows_server_2012_r2?</code></td> <td>Use to test for Windows Server 2012 R2.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">windows_vista?</code></td> <td>Use to test for Windows Vista.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">windows_xp?</code></td> <td>Use to test for Windows XP.</td> </tr> </tbody> </table> <p>The following example installs Windows PowerShell 2.0 on systems that do not already have it installed. Microsoft Windows platform helper methods are used to define specific behaviors for specific platform versions:</p> <pre class="highlight-ruby" data-language="ruby">case node['platform']
when 'windows'

  require 'chef/win32/version'
  windows_version = Chef::ReservedNames::Win32::Version.new

  if (windows_version.windows_server_2008_r2? || windows_version.windows_7?) &amp;&amp; windows_version.core?

    windows_feature 'NetFx2-ServerCore' do
      action :install
    end
    windows_feature 'NetFx2-ServerCore-WOW64' do
      action :install
      only_if { node['kernel']['machine'] == 'x86_64' }
    end

  elsif windows_version.windows_server_2008? || windows_version.windows_server_2003_r2? ||
      windows_version.windows_server_2003? || windows_version.windows_xp?

    if windows_version.windows_server_2008?
      windows_feature 'NET-Framework-Core' do
        action :install
      end

    else
      windows_package 'Microsoft .NET Framework 2.0 Service Pack 2' do
        source node['ms_dotnet2']['url']
        checksum node['ms_dotnet2']['checksum']
        installer_type :custom
        options '/quiet /norestart'
        action :install
      end
    end
  else
    log '.NET Framework 2.0 is already enabled on this version of Windows' do
      level :warn
    end
  end
else
  log '.NET Framework 2.0 cannot be installed on platforms other than Windows' do
    level :warn
  end
end</pre> <p>The previous example is from the <a class="reference external" href="https://github.com/juliandunn/ms_dotnet2" target="_blank">ms_dotnet2 cookbook</a>, created by community member <code class="docutils literal">juliandunn</code>.</p>
<div class="_attribution">
  <p class="_attribution-p">
    © Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef™ Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/release/11-18/dsl_recipe.html" class="_attribution-link" target="_blank">https://docs.chef.io/release/11-18/dsl_recipe.html</a>
  </p>
</div>

			</div>
		</div>
	</section>

	</div>
</body>
</html>
