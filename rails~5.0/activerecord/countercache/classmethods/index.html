
<!DOCTYPE HTML>

<html lang="en">

<head>
  <meta charset="utf-8">
  <title>ActiveRecord&#58;&#58;CounterCache&#58;&#58;ClassMethods - Ruby on Rails 5.0 - W3cubDocs</title>
  
  <meta name="description" content=" Decrement a numeric field by one, via a direct SQL update. ">
  <meta name="keywords" content="module, activerecord, countercache, classmethods, -, ruby, on, rails, rails~5.0">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="http://docs.w3cub.com/rails~5.0/activerecord/countercache/classmethods/">
  <link href="/favicon.png" rel="icon">
  <link type="text/css" rel="stylesheet" href="/assets/application-50364fff564ce3b6327021805f3f00e2957b441cf27f576a7dd4ff63bbc47047.css">
  <script type="text/javascript" src="/assets/application-db64bfd54ceb42be11af7995804cf4902548419ceb79d509b0b7d62c22d98e6f.js"></script>
  <script src="/json/rails~5.0.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
	<div class="_app">
	<header class="_header">
  
  <form class="_search">
    <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
    <a class="_search-clear"></a>
    <div class="_search-tag"></div>
  </form>
  
  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/rails~5.0/" class="_nav-link" title="" style="margin-left:0;">Ruby on Rails 5.0</a></span>
  
  <nav class="_nav">
    <a href="/app/" class="_nav-link ">App</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		<div class="_list">
			
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<div class="_page _rdoc">
				
<h1 id="module-ActiveRecord::CounterCache::ClassMethods" class="module"> module ActiveRecord::CounterCache::ClassMethods </h1>  <section id="5Buntitled-5D" class="documentation-section"> <section id="public-instance-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Public Instance Methods</h3> </header> <div class="method-detail "> <div class="method-heading" id="method-i-decrement_counter"> <span class="method-name">decrement_counter</span><span class="method-args">(counter_name, id)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description"> <p>Decrement a numeric field by one, via a direct SQL update.</p> <p>This works the same as <a href="../classmethods/#method-i-increment_counter">increment_counter</a> but reduces the column value by 1 instead of increasing it.</p> <h4 id="method-i-decrement_counter-label-Parameters">Parameters</h4> <ul>
<li> <p><code>counter_name</code> - The name of the field that should be decremented.</p> </li>
<li> <p><code>id</code> - The id of the object that should be decremented or an array of ids.</p> </li>
</ul> <h4 id="method-i-decrement_counter-label-Examples">Examples</h4> <pre class="ruby" data-language="ruby"># Decrement the posts_count column for the record with an id of 5
DiscussionBoard.decrement_counter(:posts_count, 5)
</pre> <div class="method-source-code" id="decrement_counter-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/counter_cache.rb, line 120
def decrement_counter(counter_name, id)
  update_counters(id, counter_name =&gt; -1)
end</pre> </div> </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-increment_counter"> <span class="method-name">increment_counter</span><span class="method-args">(counter_name, id)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description"> <p>Increment a numeric field by one, via a direct SQL update.</p> <p>This method is used primarily for maintaining counter_cache columns that are used to store aggregate values. For example, a <code>DiscussionBoard</code> may cache posts_count and comments_count to avoid running an SQL query to calculate the number of posts and comments there are, each time it is displayed.</p> <h4 id="method-i-increment_counter-label-Parameters">Parameters</h4> <ul>
<li> <p><code>counter_name</code> - The name of the field that should be incremented.</p> </li>
<li> <p><code>id</code> - The id of the object that should be incremented or an array of ids.</p> </li>
</ul> <h4 id="method-i-increment_counter-label-Examples">Examples</h4> <pre class="ruby" data-language="ruby"># Increment the posts_count column for the record with an id of 5
DiscussionBoard.increment_counter(:posts_count, 5)
</pre> <div class="method-source-code" id="increment_counter-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/counter_cache.rb, line 102
def increment_counter(counter_name, id)
  update_counters(id, counter_name =&gt; 1)
end</pre> </div> </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-reset_counters"> <span class="method-name">reset_counters</span><span class="method-args">(id, *counters)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description"> <p>Resets one or more counter caches to their correct value using an SQL count query. This is useful when adding new counter caches, or if the counter has been corrupted or modified directly by SQL.</p> <h4 id="method-i-reset_counters-label-Parameters">Parameters</h4> <ul>
<li> <p><code>id</code> - The id of the object you wish to reset a counter on.</p> </li>
<li> <p><code>counters</code> - One or more association counters to reset. Association name or counter name can be given.</p> </li>
</ul> <h4 id="method-i-reset_counters-label-Examples">Examples</h4> <pre class="ruby" data-language="ruby"># For Post with id #1 records reset the comments_count
Post.reset_counters(1, :comments)
</pre> <div class="method-source-code" id="reset_counters-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/counter_cache.rb, line 20
def reset_counters(id, *counters)
  object = find(id)
  counters.each do |counter_association|
    has_many_association = _reflect_on_association(counter_association)
    unless has_many_association
      has_many = reflect_on_all_associations(:has_many)
      has_many_association = has_many.find { |association| association.counter_cache_column &amp;&amp; association.counter_cache_column.to_sym == counter_association.to_sym }
      counter_association = has_many_association.plural_name if has_many_association
    end
    raise ArgumentError, "'#{self.name}' has no association called '#{counter_association}'" unless has_many_association

    if has_many_association.is_a? ActiveRecord::Reflection::ThroughReflection
      has_many_association = has_many_association.through_reflection
    end

    foreign_key  = has_many_association.foreign_key.to_s
    child_class  = has_many_association.klass
    reflection   = child_class._reflections.values.find { |e| e.belongs_to? &amp;&amp; e.foreign_key.to_s == foreign_key &amp;&amp; e.options[:counter_cache].present? }
    counter_name = reflection.counter_cache_column

    unscoped.where(primary_key =&gt; object.id).update_all(
      counter_name =&gt; object.send(counter_association).count(:all)
    )
  end
  return true
end</pre> </div> </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-update_counters"> <span class="method-name">update_counters</span><span class="method-args">(id, counters)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description"> <p>A generic “counter updater” implementation, intended primarily to be used by <a href="../classmethods/#method-i-increment_counter">increment_counter</a> and <a href="../classmethods/#method-i-decrement_counter">decrement_counter</a>, but which may also be useful on its own. It simply does a direct SQL update for the record with the given ID, altering the given hash of counters by the amount given by the corresponding value:</p> <h4 id="method-i-update_counters-label-Parameters">Parameters</h4> <ul>
<li> <p><code>id</code> - The id of the object you wish to update a counter on or an array of ids.</p> </li>
<li> <p><code>counters</code> - A <a href="../../../hash/">Hash</a> containing the names of the fields to update as keys and the amount to update the field by as values.</p> </li>
</ul> <h4 id="method-i-update_counters-label-Examples">Examples</h4> <pre class="ruby" data-language="ruby"># For the Post with id of 5, decrement the comment_count by 1, and
# increment the action_count by 1
Post.update_counters 5, comment_count: -1, action_count: 1
# Executes the following SQL:
# UPDATE posts
#    SET comment_count = COALESCE(comment_count, 0) - 1,
#        action_count = COALESCE(action_count, 0) + 1
#  WHERE id = 5

# For the Posts with id of 10 and 15, increment the comment_count by 1
Post.update_counters [10, 15], comment_count: 1
# Executes the following SQL:
# UPDATE posts
#    SET comment_count = COALESCE(comment_count, 0) + 1
#  WHERE id IN (10, 15)
</pre> <div class="method-source-code" id="update_counters-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/counter_cache.rb, line 76
def update_counters(id, counters)
  updates = counters.map do |counter_name, value|
    operator = value &lt; 0 ? '-' : '+'
    quoted_column = connection.quote_column_name(counter_name)
    "#{quoted_column} = COALESCE(#{quoted_column}, 0) #{operator} #{value.abs}"
  end

  unscoped.where(primary_key =&gt; id).update_all updates.join(', ')
end</pre> </div> </div> </div> </section> </section><div class="_attribution">
  <p class="_attribution-p">
    © 2004–2017 David Heinemeier Hansson<br>Licensed under the MIT License.<br>
    
  </p>
</div>

			</div>
		</div>
	</section>

	</div>
</body>
</html>
