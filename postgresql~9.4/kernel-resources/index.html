
<!DOCTYPE HTML>

<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Managing Kernel Resources - PostgreSQL 9.4 - W3cubDocs</title>
  
  <meta name="description" content="PostgreSQL can sometimes exhaust various operating system resource limits, especially when multiple copies of the server are running on the same &hellip;">
  <meta name="keywords" content="managing, kernel, resources, -, postgresql, postgresql~9.4">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="http://docs.w3cub.com/postgresql~9.4/kernel-resources/">
  <link href="/favicon.png" rel="icon">
  <link type="text/css" rel="stylesheet" href="/assets/application-50364fff564ce3b6327021805f3f00e2957b441cf27f576a7dd4ff63bbc47047.css">
  <script type="text/javascript" src="/assets/application-db64bfd54ceb42be11af7995804cf4902548419ceb79d509b0b7d62c22d98e6f.js"></script>
  <script src="/json/postgresql~9.4.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body>
	<div class="_app">
	<header class="_header">
  
  <form class="_search">
    <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
    <a class="_search-clear"></a>
    <div class="_search-tag"></div>
  </form>
  
  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/postgresql~9.4/" class="_nav-link" title="" style="margin-left:0;">PostgreSQL 9.4</a></span>
  
  <nav class="_nav">
    <a href="/app/" class="_nav-link ">App</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		<div class="_list">
			
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<div class="_page _postgres">
				
<h1 class="SECT1" id="KERNEL-RESOURCES">17.4. Managing Kernel Resources</h1> <p><span class="PRODUCTNAME">PostgreSQL</span> can sometimes exhaust various operating system resource limits, especially when multiple copies of the server are running on the same system, or in very large installations. This section explains the kernel resources used by <span class="PRODUCTNAME">PostgreSQL</span> and the steps you can take to resolve problems related to kernel resource consumption.</p> <div class="SECT2"> <h2 class="SECT2" id="SYSVIPC">17.4.1. Shared Memory and Semaphores</h2> <p>Shared memory and semaphores are collectively referred to as <span class="QUOTE">"<span class="SYSTEMITEM">System V</span> <acronym class="ACRONYM">IPC</acronym>"</span> (together with message queues, which are not relevant for <span class="PRODUCTNAME">PostgreSQL</span>). Except on <span class="SYSTEMITEM">Windows</span>, where <span class="PRODUCTNAME">PostgreSQL</span> provides its own replacement implementation of these facilities, these facilities are required in order to run <span class="PRODUCTNAME">PostgreSQL</span>.</p> <p>The complete lack of these facilities is usually manifested by an <span class="ERRORNAME">Illegal system call</span> error upon server start. In that case there is no alternative but to reconfigure your kernel. <span class="PRODUCTNAME">PostgreSQL</span> won't work without them. This situation is rare, however, among modern operating systems.</p> <p>When <span class="PRODUCTNAME">PostgreSQL</span> exceeds one of the various hard <acronym class="ACRONYM">IPC</acronym> limits, the server will refuse to start and should leave an instructive error message describing the problem and what to do about it. (See also <a href="../server-start/#SERVER-START-FAILURES">Section 17.3.1</a>.) The relevant kernel parameters are named consistently across different systems; <a href="../kernel-resources/#SYSVIPC-PARAMETERS">Table 17-1</a> gives an overview. The methods to set them, however, vary. Suggestions for some platforms are given below.</p>  <blockquote class="NOTE"> <p><b>Note:</b> Prior to <span class="PRODUCTNAME">PostgreSQL</span> 9.3, the amount of System V shared memory required to start the server was much larger. If you are running an older version of the server, please consult the documentation for your server version.</p> </blockquote>  <div class="TABLE" id="SYSVIPC-PARAMETERS">  <p class="c2">Table 17-1. <span class="SYSTEMITEM">System V</span> <acronym class="ACRONYM">IPC</acronym> Parameters</p> <table class="CALSTABLE"> <col> <col> <col> <thead> <tr> <th>Name</th> <th>Description</th> <th>Reasonable values</th> </tr> </thead> <tbody> <tr> <td><code class="VARNAME">SHMMAX</code></td> <td>Maximum size of shared memory segment (bytes)</td> <td>at least 1kB (more if running many copies of the server)</td> </tr> <tr> <td><code class="VARNAME">SHMMIN</code></td> <td>Minimum size of shared memory segment (bytes)</td> <td>1</td> </tr> <tr> <td><code class="VARNAME">SHMALL</code></td> <td>Total amount of shared memory available (bytes or pages)</td> <td>if bytes, same as <code class="VARNAME">SHMMAX</code>; if pages, <code class="LITERAL">ceil(SHMMAX/PAGE_SIZE)</code>
</td> </tr> <tr> <td><code class="VARNAME">SHMSEG</code></td> <td>Maximum number of shared memory segments per process</td> <td>only 1 segment is needed, but the default is much higher</td> </tr> <tr> <td><code class="VARNAME">SHMMNI</code></td> <td>Maximum number of shared memory segments system-wide</td> <td>like <code class="VARNAME">SHMSEG</code> plus room for other applications</td> </tr> <tr> <td><code class="VARNAME">SEMMNI</code></td> <td>Maximum number of semaphore identifiers (i.e., sets)</td> <td>at least <code class="LITERAL">ceil((max_connections + autovacuum_max_workers + max_worker_processes + 5) / 16)</code>
</td> </tr> <tr> <td><code class="VARNAME">SEMMNS</code></td> <td>Maximum number of semaphores system-wide</td> <td>
<code class="LITERAL">ceil((max_connections + autovacuum_max_workers + max_worker_processes + 5) / 16) * 17</code> plus room for other applications</td> </tr> <tr> <td><code class="VARNAME">SEMMSL</code></td> <td>Maximum number of semaphores per set</td> <td>at least 17</td> </tr> <tr> <td><code class="VARNAME">SEMMAP</code></td> <td>Number of entries in semaphore map</td> <td>see text</td> </tr> <tr> <td><code class="VARNAME">SEMVMX</code></td> <td>Maximum value of semaphore</td> <td>at least 1000 (The default is often 32767; do not change unless necessary)</td> </tr> </tbody> </table> </div> <p><span class="PRODUCTNAME">PostgreSQL</span> requires a few bytes of System V shared memory (typically 48 bytes, on 64-bit platforms) for each copy of the server. On most modern operating systems, this amount can easily be allocated. However, if you are running many copies of the server, or if other applications are also using System V shared memory, it may be necessary to increase <code class="VARNAME">SHMMAX</code>, the maximum size in bytes of a shared memory segment, or <code class="VARNAME">SHMALL</code>, the total amount of System V shared memory system-wide. Note that <code class="VARNAME">SHMALL</code> is measured in pages rather than bytes on many systems.</p> <p>Less likely to cause problems is the minimum size for shared memory segments (<code class="VARNAME">SHMMIN</code>), which should be at most approximately 32 bytes for <span class="PRODUCTNAME">PostgreSQL</span> (it is usually just 1). The maximum number of segments system-wide (<code class="VARNAME">SHMMNI</code>) or per-process (<code class="VARNAME">SHMSEG</code>) are unlikely to cause a problem unless your system has them set to zero.</p> <p><span class="PRODUCTNAME">PostgreSQL</span> uses one semaphore per allowed connection (<a href="../runtime-config-connection/#GUC-MAX-CONNECTIONS">max_connections</a>), allowed autovacuum worker process (<a href="../runtime-config-autovacuum/#GUC-AUTOVACUUM-MAX-WORKERS">autovacuum_max_workers</a>) and allowed background process (<a href="../runtime-config-resource/#GUC-MAX-WORKER-PROCESSES">max_worker_processes</a>), in sets of 16. Each such set will also contain a 17th semaphore which contains a <span class="QUOTE">"magic number"</span>, to detect collision with semaphore sets used by other applications. The maximum number of semaphores in the system is set by <code class="VARNAME">SEMMNS</code>, which consequently must be at least as high as <code class="VARNAME">max_connections</code> plus <code class="VARNAME">autovacuum_max_workers</code> plus <code class="VARNAME">max_worker_processes</code>, plus one extra for each 16 allowed connections plus workers (see the formula in <a href="../kernel-resources/#SYSVIPC-PARAMETERS">Table 17-1</a>). The parameter <code class="VARNAME">SEMMNI</code> determines the limit on the number of semaphore sets that can exist on the system at one time. Hence this parameter must be at least <code class="LITERAL">ceil((max_connections + autovacuum_max_workers + max_worker_processes + 5) / 16)</code>. Lowering the number of allowed connections is a temporary workaround for failures, which are usually confusingly worded <span class="QUOTE">"No space left on device"</span>, from the function <code class="FUNCTION">semget</code>.</p> <p>In some cases it might also be necessary to increase <code class="VARNAME">SEMMAP</code> to be at least on the order of <code class="VARNAME">SEMMNS</code>. This parameter defines the size of the semaphore resource map, in which each contiguous block of available semaphores needs an entry. When a semaphore set is freed it is either added to an existing entry that is adjacent to the freed block or it is registered under a new map entry. If the map is full, the freed semaphores get lost (until reboot). Fragmentation of the semaphore space could over time lead to fewer available semaphores than there should be.</p> <p>The <code class="VARNAME">SEMMSL</code> parameter, which determines how many semaphores can be in a set, must be at least 17 for <span class="PRODUCTNAME">PostgreSQL</span>.</p> <p>Various other settings related to <span class="QUOTE">"semaphore undo"</span>, such as <code class="VARNAME">SEMMNU</code> and <code class="VARNAME">SEMUME</code>, do not affect <span class="PRODUCTNAME">PostgreSQL</span>.</p> <div class="VARIABLELIST"> <dl> <dt><span class="SYSTEMITEM">AIX</span></dt> <dd> <p>At least as of version 5.1, it should not be necessary to do any special configuration for such parameters as <code class="VARNAME">SHMMAX</code>, as it appears this is configured to allow all memory to be used as shared memory. That is the sort of configuration commonly used for other databases such as <span class="APPLICATION">DB/2</span>.</p> <p>It might, however, be necessary to modify the global <code class="COMMAND">ulimit</code> information in <code class="FILENAME">/etc/security/limits</code>, as the default hard limits for file sizes (<code class="VARNAME">fsize</code>) and numbers of files (<code class="VARNAME">nofiles</code>) might be too low.</p> </dd> <dt><span class="SYSTEMITEM">FreeBSD</span></dt> <dd> <p>The default settings can be changed using the <code class="COMMAND">sysctl</code> or <code class="COMMAND">loader</code> interfaces. The following parameters can be set using <code class="COMMAND">sysctl</code>:</p> <pre class="SCREEN">
<samp class="PROMPT">#</samp> sysctl kern.ipc.shmall=32768
<samp class="PROMPT">#</samp> sysctl kern.ipc.shmmax=134217728
</pre> <p>To make these settings persist over reboots, modify <code class="FILENAME">/etc/sysctl.conf</code>.</p> <p>These semaphore-related settings are read-only as far as <code class="COMMAND">sysctl</code> is concerned, but can be set in <code class="FILENAME">/boot/loader.conf</code>:</p> <pre class="PROGRAMLISTING" data-language="sql">
kern.ipc.semmni=256
kern.ipc.semmns=512
kern.ipc.semmnu=256
</pre> <p>After modifying these values a reboot is required for the new settings to take effect. (Note: FreeBSD does not use <code class="VARNAME">SEMMAP</code>. Older versions would accept but ignore a setting for <code class="LITERAL">kern.ipc.semmap</code>; newer versions reject it altogether.)</p> <p>You might also want to configure your kernel to lock shared memory into RAM and prevent it from being paged out to swap. This can be accomplished using the <code class="COMMAND">sysctl</code> setting <code class="LITERAL">kern.ipc.shm_use_phys</code>.</p> <p>If running in FreeBSD jails by enabling <span class="APPLICATION">sysctl</span>'s <code class="LITERAL">security.jail.sysvipc_allowed</code>, <span class="APPLICATION">postmaster</span>s running in different jails should be run by different operating system users. This improves security because it prevents non-root users from interfering with shared memory or semaphores in different jails, and it allows the PostgreSQL IPC cleanup code to function properly. (In FreeBSD 6.0 and later the IPC cleanup code does not properly detect processes in other jails, preventing the running of postmasters on the same port in different jails.)</p> <p><span class="SYSTEMITEM">FreeBSD</span> versions before 4.0 work like <span class="SYSTEMITEM">OpenBSD</span> (see below).</p> </dd> <dt><span class="SYSTEMITEM">NetBSD</span></dt> <dd> <p>In <span class="SYSTEMITEM">NetBSD</span> 5.0 and later, IPC parameters can be adjusted using <code class="COMMAND">sysctl</code>, for example:</p> <pre class="SCREEN">
<samp class="PROMPT">$</samp> sysctl -w kern.ipc.shmmax=16777216
</pre> <p>To have these settings persist over reboots, modify <code class="FILENAME">/etc/sysctl.conf</code>.</p> <p>You might also want to configure your kernel to lock shared memory into RAM and prevent it from being paged out to swap. This can be accomplished using the <code class="COMMAND">sysctl</code> setting <code class="LITERAL">kern.ipc.shm_use_phys</code>.</p> <p><span class="SYSTEMITEM">NetBSD</span> versions before 5.0 work like <span class="SYSTEMITEM">OpenBSD</span> (see below), except that parameters should be set with the keyword <code class="LITERAL">options</code> not <code class="LITERAL">option</code>.</p> </dd> <dt><span class="SYSTEMITEM">OpenBSD</span></dt> <dd> <p>The options <code class="VARNAME">SYSVSHM</code> and <code class="VARNAME">SYSVSEM</code> need to be enabled when the kernel is compiled. (They are by default.) The maximum size of shared memory is determined by the option <code class="VARNAME">SHMMAXPGS</code> (in pages). The following shows an example of how to set the various parameters:</p> <pre class="PROGRAMLISTING" data-language="sql">
option        SYSVSHM
option        SHMMAXPGS=4096
option        SHMSEG=256

option        SYSVSEM
option        SEMMNI=256
option        SEMMNS=512
option        SEMMNU=256
option        SEMMAP=256
</pre> <p>You might also want to configure your kernel to lock shared memory into RAM and prevent it from being paged out to swap. This can be accomplished using the <code class="COMMAND">sysctl</code> setting <code class="LITERAL">kern.ipc.shm_use_phys</code>.</p> </dd> <dt><span class="SYSTEMITEM">HP-UX</span></dt> <dd> <p>The default settings tend to suffice for normal installations. On <span class="PRODUCTNAME">HP-UX</span> 10, the factory default for <code class="VARNAME">SEMMNS</code> is 128, which might be too low for larger database sites.</p> <p><acronym class="ACRONYM">IPC</acronym> parameters can be set in the <span class="APPLICATION">System Administration Manager</span> (<acronym class="ACRONYM">SAM</acronym>) under <span class="GUIMENU">Kernel Configuration</span>-&gt;<span class="GUIMENUITEM">Configurable Parameters</span>. Choose <span class="GUIBUTTON">Create A New Kernel</span> when you're done.</p> </dd> <dt><span class="SYSTEMITEM">Linux</span></dt> <dd> <p>The default maximum segment size is 32 MB, and the default maximum total size is 2097152 pages. A page is almost always 4096 bytes except in unusual kernel configurations with <span class="QUOTE">"huge pages"</span> (use <code class="LITERAL">getconf PAGE_SIZE</code> to verify).</p> <p>The shared memory size settings can be changed via the <code class="COMMAND">sysctl</code> interface. For example, to allow 16 GB:</p> <pre class="SCREEN">
<samp class="PROMPT">$</samp> sysctl -w kernel.shmmax=17179869184
<samp class="PROMPT">$</samp> sysctl -w kernel.shmall=4194304
</pre> <p>In addition these settings can be preserved between reboots in the file <code class="FILENAME">/etc/sysctl.conf</code>. Doing that is highly recommended.</p> <p>Ancient distributions might not have the <code class="COMMAND">sysctl</code> program, but equivalent changes can be made by manipulating the <code class="FILENAME">/proc</code> file system:</p> <pre class="SCREEN">
<samp class="PROMPT">$</samp> echo 17179869184 &gt;/proc/sys/kernel/shmmax
<samp class="PROMPT">$</samp> echo 4194304 &gt;/proc/sys/kernel/shmall
</pre> <p>The remaining defaults are quite generously sized, and usually do not require changes.</p> </dd> <dt><span class="SYSTEMITEM">OS X</span></dt> <dd> <p>The recommended method for configuring shared memory in OS X is to create a file named <code class="FILENAME">/etc/sysctl.conf</code>, containing variable assignments such as:</p> <pre class="PROGRAMLISTING" data-language="sql">
kern.sysv.shmmax=4194304
kern.sysv.shmmin=1
kern.sysv.shmmni=32
kern.sysv.shmseg=8
kern.sysv.shmall=1024
</pre> <p>Note that in some OS X versions, <span class="emphasis EMPHASIS c3">all five</span> shared-memory parameters must be set in <code class="FILENAME">/etc/sysctl.conf</code>, else the values will be ignored.</p> <p>Beware that recent releases of OS X ignore attempts to set <code class="VARNAME">SHMMAX</code> to a value that isn't an exact multiple of 4096.</p> <p><code class="VARNAME">SHMALL</code> is measured in 4 kB pages on this platform.</p> <p>In older OS X versions, you will need to reboot to have changes in the shared memory parameters take effect. As of 10.5 it is possible to change all but <code class="VARNAME">SHMMNI</code> on the fly, using <span class="APPLICATION">sysctl</span>. But it's still best to set up your preferred values via <code class="FILENAME">/etc/sysctl.conf</code>, so that the values will be kept across reboots.</p> <p>The file <code class="FILENAME">/etc/sysctl.conf</code> is only honored in OS X 10.3.9 and later. If you are running a previous 10.3.x release, you must edit the file <code class="FILENAME">/etc/rc</code> and change the values in the following commands:</p> <pre class="PROGRAMLISTING" data-language="sql">
sysctl -w kern.sysv.shmmax
sysctl -w kern.sysv.shmmin
sysctl -w kern.sysv.shmmni
sysctl -w kern.sysv.shmseg
sysctl -w kern.sysv.shmall
</pre> <p>Note that <code class="FILENAME">/etc/rc</code> is usually overwritten by OS X system updates, so you should expect to have to redo these edits after each update.</p> <p>In OS X 10.2 and earlier, instead edit these commands in the file <code class="FILENAME">/System/Library/StartupItems/SystemTuning/SystemTuning</code>.</p> </dd> <dt><span class="SYSTEMITEM">SCO OpenServer</span></dt> <dd> <p>In the default configuration, only 512 kB of shared memory per segment is allowed. To increase the setting, first change to the directory <code class="FILENAME">/etc/conf/cf.d</code>. To display the current value of <code class="VARNAME">SHMMAX</code>, run:</p> <pre class="PROGRAMLISTING" data-language="sql">
./configure -y SHMMAX
</pre> <p>To set a new value for <code class="VARNAME">SHMMAX</code>, run:</p> <pre class="PROGRAMLISTING" data-language="sql">
./configure SHMMAX=value
</pre> <p>where <code class="REPLACEABLE c4">value</code> is the new value you want to use (in bytes). After setting <code class="VARNAME">SHMMAX</code>, rebuild the kernel:</p> <pre class="PROGRAMLISTING" data-language="sql">
./link_unix
</pre> <p>and reboot.</p> </dd> <dt>
<span class="SYSTEMITEM">Solaris</span> 2.6 to 2.9 (Solaris 6 to Solaris 9)</dt> <dd> <p>The relevant settings can be changed in <code class="FILENAME">/etc/system</code>, for example:</p> <pre class="PROGRAMLISTING" data-language="sql">
set shmsys:shminfo_shmmax=0x2000000
set shmsys:shminfo_shmmin=1
set shmsys:shminfo_shmmni=256
set shmsys:shminfo_shmseg=256

set semsys:seminfo_semmap=256
set semsys:seminfo_semmni=512
set semsys:seminfo_semmns=512
set semsys:seminfo_semmsl=32
</pre> <p>You need to reboot for the changes to take effect. See also <a href="http://sunsite.uakom.sk/sunworldonline/swol-09-1997/swol-09-insidesolaris.html" target="_blank">http://sunsite.uakom.sk/sunworldonline/swol-09-1997/swol-09-insidesolaris.html</a> for information on shared memory under older versions of Solaris.</p> </dd> <dt>
<span class="SYSTEMITEM">Solaris</span> 2.10 (Solaris 10) and later<br> <span class="SYSTEMITEM">OpenSolaris</span>
</dt> <dd> <p>In Solaris 10 and later, and OpenSolaris, the default shared memory and semaphore settings are good enough for most <span class="PRODUCTNAME">PostgreSQL</span> applications. Solaris now defaults to a <code class="VARNAME">SHMMAX</code> of one-quarter of system <acronym class="ACRONYM">RAM</acronym>. To further adjust this setting, use a project setting associated with the <code class="LITERAL">postgres</code> user. For example, run the following as <code class="LITERAL">root</code>:</p> <pre class="PROGRAMLISTING" data-language="sql">
projadd -c "PostgreSQL DB User" -K "project.max-shm-memory=(privileged,8GB,deny)" -U postgres -G postgres user.postgres
</pre> <p>This command adds the <code class="LITERAL">user.postgres</code> project and sets the shared memory maximum for the <code class="LITERAL">postgres</code> user to 8GB, and takes effect the next time that user logs in, or when you restart <span class="PRODUCTNAME">PostgreSQL</span> (not reload). The above assumes that <span class="PRODUCTNAME">PostgreSQL</span> is run by the <code class="LITERAL">postgres</code> user in the <code class="LITERAL">postgres</code> group. No server reboot is required.</p> <p>Other recommended kernel setting changes for database servers which will have a large number of connections are:</p> <pre class="PROGRAMLISTING" data-language="sql">
project.max-shm-ids=(priv,32768,deny)
project.max-sem-ids=(priv,4096,deny)
project.max-msg-ids=(priv,4096,deny)
</pre> <p>Additionally, if you are running <span class="PRODUCTNAME">PostgreSQL</span> inside a zone, you may need to raise the zone resource usage limits as well. See "Chapter2: Projects and Tasks" in the <i class="CITETITLE">System Administrator's Guide</i> for more information on <code class="LITERAL">projects</code> and <code class="COMMAND">prctl</code>.</p> </dd> <dt><span class="SYSTEMITEM">UnixWare</span></dt> <dd> <p>On <span class="PRODUCTNAME">UnixWare</span> 7, the maximum size for shared memory segments is 512 kB in the default configuration. To display the current value of <code class="VARNAME">SHMMAX</code>, run:</p> <pre class="PROGRAMLISTING" data-language="sql">
/etc/conf/bin/idtune -g SHMMAX
</pre> <p>which displays the current, default, minimum, and maximum values. To set a new value for <code class="VARNAME">SHMMAX</code>, run:</p> <pre class="PROGRAMLISTING" data-language="sql">
/etc/conf/bin/idtune SHMMAX value
</pre> <p>where <code class="REPLACEABLE c4">value</code> is the new value you want to use (in bytes). After setting <code class="VARNAME">SHMMAX</code>, rebuild the kernel:</p> <pre class="PROGRAMLISTING" data-language="sql">
/etc/conf/bin/idbuild -B
</pre> <p>and reboot.</p> </dd> </dl> </div> </div> <div class="SECT2"> <h2 class="SECT2" id="AEN29045">17.4.2. Resource Limits</h2> <p>Unix-like operating systems enforce various kinds of resource limits that might interfere with the operation of your <span class="PRODUCTNAME">PostgreSQL</span> server. Of particular importance are limits on the number of processes per user, the number of open files per process, and the amount of memory available to each process. Each of these have a <span class="QUOTE">"hard"</span> and a <span class="QUOTE">"soft"</span> limit. The soft limit is what actually counts but it can be changed by the user up to the hard limit. The hard limit can only be changed by the root user. The system call <code class="FUNCTION">setrlimit</code> is responsible for setting these parameters. The shell's built-in command <code class="COMMAND">ulimit</code> (Bourne shells) or <code class="COMMAND">limit</code> (<span class="APPLICATION">csh</span>) is used to control the resource limits from the command line. On BSD-derived systems the file <code class="FILENAME">/etc/login.conf</code> controls the various resource limits set during login. See the operating system documentation for details. The relevant parameters are <code class="VARNAME">maxproc</code>, <code class="VARNAME">openfiles</code>, and <code class="VARNAME">datasize</code>. For example:</p> <pre class="PROGRAMLISTING" data-language="sql">
default:\
...
        :datasize-cur=256M:\
        :maxproc-cur=256:\
        :openfiles-cur=256:\
...
</pre> <p>(<code class="LITERAL">-cur</code> is the soft limit. Append <code class="LITERAL">-max</code> to set the hard limit.)</p> <p>Kernels can also have system-wide limits on some resources.</p> <ul> <li> <p>On <span class="PRODUCTNAME">Linux</span> <code class="FILENAME">/proc/sys/fs/file-max</code> determines the maximum number of open files that the kernel will support. It can be changed by writing a different number into the file or by adding an assignment in <code class="FILENAME">/etc/sysctl.conf</code>. The maximum limit of files per process is fixed at the time the kernel is compiled; see <code class="FILENAME">/usr/src/linux/Documentation/proc.txt</code> for more information.</p> </li> </ul> <p>The <span class="PRODUCTNAME">PostgreSQL</span> server uses one process per connection so you should provide for at least as many processes as allowed connections, in addition to what you need for the rest of your system. This is usually not a problem but if you run several servers on one machine things might get tight.</p> <p>The factory default limit on open files is often set to <span class="QUOTE">"socially friendly"</span> values that allow many users to coexist on a machine without using an inappropriate fraction of the system resources. If you run many servers on a machine this is perhaps what you want, but on dedicated servers you might want to raise this limit.</p> <p>On the other side of the coin, some systems allow individual processes to open large numbers of files; if more than a few processes do so then the system-wide limit can easily be exceeded. If you find this happening, and you do not want to alter the system-wide limit, you can set <span class="PRODUCTNAME">PostgreSQL</span>'s <a href="../runtime-config-resource/#GUC-MAX-FILES-PER-PROCESS">max_files_per_process</a> configuration parameter to limit the consumption of open files.</p> </div> <div class="SECT2"> <h2 class="SECT2" id="LINUX-MEMORY-OVERCOMMIT">17.4.3. Linux Memory Overcommit</h2> <p>In Linux 2.4 and later, the default virtual memory behavior is not optimal for <span class="PRODUCTNAME">PostgreSQL</span>. Because of the way that the kernel implements memory overcommit, the kernel might terminate the <span class="PRODUCTNAME">PostgreSQL</span> postmaster (the master server process) if the memory demands of either <span class="PRODUCTNAME">PostgreSQL</span> or another process cause the system to run out of virtual memory.</p> <p>If this happens, you will see a kernel message that looks like this (consult your system documentation and configuration on where to look for such a message):</p> <pre class="PROGRAMLISTING" data-language="sql">
Out of Memory: Killed process 12345 (postgres).
</pre> <p>This indicates that the <code class="FILENAME">postgres</code> process has been terminated due to memory pressure. Although existing database connections will continue to function normally, no new connections will be accepted. To recover, <span class="PRODUCTNAME">PostgreSQL</span> will need to be restarted.</p> <p>One way to avoid this problem is to run <span class="PRODUCTNAME">PostgreSQL</span> on a machine where you can be sure that other processes will not run the machine out of memory. If memory is tight, increasing the swap space of the operating system can help avoid the problem, because the out-of-memory (OOM) killer is invoked only when physical memory and swap space are exhausted.</p> <p>If <span class="PRODUCTNAME">PostgreSQL</span> itself is the cause of the system running out of memory, you can avoid the problem by changing your configuration. In some cases, it may help to lower memory-related configuration parameters, particularly <a href="../runtime-config-resource/#GUC-SHARED-BUFFERS"><code class="VARNAME">shared_buffers</code></a> and <a href="../runtime-config-resource/#GUC-WORK-MEM"><code class="VARNAME">work_mem</code></a>. In other cases, the problem may be caused by allowing too many connections to the database server itself. In many cases, it may be better to reduce <a href="../runtime-config-connection/#GUC-MAX-CONNECTIONS"><code class="VARNAME">max_connections</code></a> and instead make use of external connection-pooling software.</p> <p>On Linux 2.6 and later, it is possible to modify the kernel's behavior so that it will not <span class="QUOTE">"overcommit"</span> memory. Although this setting will not prevent the <a href="http://lwn.net/Articles/104179/" target="_blank">OOM killer</a> from being invoked altogether, it will lower the chances significantly and will therefore lead to more robust system behavior. This is done by selecting strict overcommit mode via <code class="COMMAND">sysctl</code>:</p> <pre class="PROGRAMLISTING" data-language="sql">
sysctl -w vm.overcommit_memory=2
</pre> <p>or placing an equivalent entry in <code class="FILENAME">/etc/sysctl.conf</code>. You might also wish to modify the related setting <code class="VARNAME">vm.overcommit_ratio</code>. For details see the kernel documentation file <code class="FILENAME">Documentation/vm/overcommit-accounting</code>.</p> <p>Another approach, which can be used with or without altering <code class="VARNAME">vm.overcommit_memory</code>, is to set the process-specific <code class="VARNAME">oom_score_adj</code> value for the postmaster process to <code class="LITERAL">-1000</code>, thereby guaranteeing it will not be targeted by the OOM killer. The simplest way to do this is to execute</p> <pre class="PROGRAMLISTING" data-language="sql">
echo -1000 &gt; /proc/self/oom_score_adj
</pre> <p>in the postmaster's startup script just before invoking the postmaster. Note that this action must be done as root, or it will have no effect; so a root-owned startup script is the easiest place to do it. If you do this, you may also wish to build <span class="PRODUCTNAME">PostgreSQL</span> with <code class="LITERAL">-DLINUX_OOM_SCORE_ADJ=0</code> added to <code class="VARNAME">CPPFLAGS</code>. That will cause postmaster child processes to run with the normal <code class="VARNAME">oom_score_adj</code> value of zero, so that the OOM killer can still target them at need.</p> <p>Older Linux kernels do not offer <code class="FILENAME">/proc/self/oom_score_adj</code>, but may have a previous version of the same functionality called <code class="FILENAME">/proc/self/oom_adj</code>. This works the same except the disable value is <code class="LITERAL">-17</code> not <code class="LITERAL">-1000</code>. The corresponding build flag for <span class="PRODUCTNAME">PostgreSQL</span> is <code class="LITERAL">-DLINUX_OOM_ADJ=0</code>.</p>  <blockquote class="NOTE"> <p><b>Note:</b> Some vendors' Linux 2.4 kernels are reported to have early versions of the 2.6 overcommit <code class="COMMAND">sysctl</code> parameter. However, setting <code class="LITERAL">vm.overcommit_memory</code> to 2 on a 2.4 kernel that does not have the relevant code will make things worse, not better. It is recommended that you inspect the actual kernel source code (see the function <code class="FUNCTION">vm_enough_memory</code> in the file <code class="FILENAME">mm/mmap.c</code>) to verify what is supported in your kernel before you try this in a 2.4 installation. The presence of the <code class="FILENAME">overcommit-accounting</code> documentation file should <span class="emphasis EMPHASIS c3">not</span> be taken as evidence that the feature is there. If in any doubt, consult a kernel expert or your kernel vendor.</p> </blockquote>  </div> <div class="SECT2"> <h2 class="SECT2" id="LINUX-HUGE-PAGES">17.4.4. Linux Huge Pages</h2> <p>Using huge pages reduces overhead when using large contiguous chunks of memory, as <span class="PRODUCTNAME">PostgreSQL</span> does, particularly when using large values of <a href="../runtime-config-resource/#GUC-SHARED-BUFFERS">shared_buffers</a>. To use this feature in <span class="PRODUCTNAME">PostgreSQL</span> you need a kernel with <code class="VARNAME">CONFIG_HUGETLBFS=y</code> and <code class="VARNAME">CONFIG_HUGETLB_PAGE=y</code>. You will also have to adjust the kernel setting <code class="VARNAME">vm.nr_hugepages</code>. To estimate the number of huge pages needed, start <span class="PRODUCTNAME">PostgreSQL</span> without huge pages enabled and check the postmaster's <code class="VARNAME">VmPeak</code> value, as well as the system's huge page size, using the <code class="FILENAME">/proc</code> file system. This might look like:</p> <pre class="PROGRAMLISTING" data-language="sql">
$ head -1 $PGDATA/postmaster.pid
4170
$ grep ^VmPeak /proc/4170/status
VmPeak:  6490428 kB
$ grep ^Hugepagesize /proc/meminfo
Hugepagesize:       2048 kB
</pre> <p><code class="LITERAL">6490428</code> / <code class="LITERAL">2048</code> gives approximately <code class="LITERAL">3169.154</code>, so in this example we need at least <code class="LITERAL">3170</code> huge pages, which we can set with:</p> <pre class="PROGRAMLISTING" data-language="sql">
$ sysctl -w vm.nr_hugepages=3170
</pre> <p>A larger setting would be appropriate if other programs on the machine also need huge pages. Don't forget to add this setting to <code class="FILENAME">/etc/sysctl.conf</code> so that it will be reapplied after reboots.</p> <p>Sometimes the kernel is not able to allocate the desired number of huge pages immediately, so it might be necessary to repeat the command or to reboot. (Immediately after a reboot, most of the machine's memory should be available to convert into huge pages.) To verify the huge page allocation situation, use:</p> <pre class="PROGRAMLISTING" data-language="sql">
$ grep Huge /proc/meminfo
</pre> <p>It may also be necessary to give the database server's operating system user permission to use huge pages by setting <code class="VARNAME">vm.hugetlb_shm_group</code> via <span class="APPLICATION">sysctl</span>, and/or give permission to lock memory with <code class="COMMAND">ulimit -l</code>.</p> <p>The default behavior for huge pages in <span class="PRODUCTNAME">PostgreSQL</span> is to use them when possible and to fall back to normal pages when failing. To enforce the use of huge pages, you can set <a href="../runtime-config-resource/#GUC-HUGE-PAGES">huge_pages</a> to <code class="LITERAL">on</code> in <code class="FILENAME">postgresql.conf</code>. Note that with this setting <span class="PRODUCTNAME">PostgreSQL</span> will fail to start if not enough huge pages are available.</p> <p>For a detailed description of the <span class="PRODUCTNAME">Linux</span> huge pages feature have a look at <a href="https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt" target="_blank">https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt</a>.</p> </div>  <div class="NAVFOOTER">  <table summary="Footer navigation table"> <tr> <td width="33%" align="left"><a href="../server-start/" accesskey="P">Prev</a></td> <td width="34%" align="center"></td> <td width="33%" align="right"><a href="../server-shutdown/" accesskey="N">Next</a></td> </tr> <tr> <td width="33%" align="left">Starting the Database Server</td> <td width="34%" align="center"><a href="https://www.postgresql.org/docs/9.4/static/runtime.html" accesskey="U" target="_blank">Up</a></td> <td width="33%" align="right">Shutting Down the Server</td> </tr> </table> </div>
<div class="_attribution">
  <p class="_attribution-p">
    © 1996–2017 The PostgreSQL Global Development Group<br>Licensed under the PostgreSQL License.<br>
    <a href="https://www.postgresql.org/docs/9.4/static/kernel-resources.html" class="_attribution-link" target="_blank">https://www.postgresql.org/docs/9.4/static/kernel-resources.html</a>
  </p>
</div>

			</div>
		</div>
	</section>

	</div>
</body>
</html>
